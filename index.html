<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Idle Realm</title>

    <!-- Pi SDK (auth resta, ma qui non lo usiamo ancora) -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
      Pi.init({ version: "2.0" });
    </script>

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont;
        background: #111;
        color: #eee;
        padding: 24px;
      }

      h1 {
        margin-bottom: 10px;
      }

      pre {
        background: #1e1e1e;
        padding: 16px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.4;
      }

      button {
        margin-top: 16px;
        padding: 10px 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        background: #3a6df0;
        color: white;
        font-size: 14px;
      }

      button:hover {
        background: #2f5bd3;
      }
    </style>
  </head>

  <body>
    <h1>Idle Realm</h1>
    <p>Local-first idle world simulation</p>

    <pre id="output">loading...</pre>

    <button onclick="resetGame()">Reset World</button>

    <script>
      /*************************************************
       * CONFIG
       *************************************************/
      const STORAGE_KEY = "idle_realm_save";

      const DEFAULT_STATE = {
        meta: {
          version: 1,
          createdAt: Date.now(),
          lastTick: Date.now()
        },

        realm: {
          name: "Idle Realm",
          era: "foundations"
        },

        resources: {
          population: 10,
          production: 5,
          stability: 70
        },

        buildings: {
          settlement: 1,
          workshop: 0,
          council: 0
        },

        modifiers: {
          productionBonus: 1.0,
          stabilityBonus: 1.0
        },

        stats: {
          totalPlayTime: 0,
          ticks: 0
        }
      };

      /*************************************************
       * LOAD / SAVE
       *************************************************/
      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(DEFAULT_STATE);

        try {
          const parsed = JSON.parse(raw);
          return migrateState(parsed);
        } catch {
          return structuredClone(DEFAULT_STATE);
        }
      }

      function saveState(state) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function migrateState(state) {
        if (!state.meta || state.meta.version !== 1) {
          return structuredClone(DEFAULT_STATE);
        }
        return state;
      }

      /*************************************************
       * TIME SIMULATION (IDLE CORE)
       *************************************************/
      function applyTime(state) {
        const now = Date.now();
        const elapsedMs = now - state.meta.lastTick;
        const elapsedSeconds = Math.floor(elapsedMs / 1000);

        if (elapsedSeconds <= 0) return state;

        // Production grows with population
        const productionRate =
          state.resources.population *
          0.1 *
          state.modifiers.productionBonus;

        state.resources.production += productionRate * elapsedSeconds;

        // Population grows slowly if stable
        if (state.resources.stability > 50) {
          state.resources.population += elapsedSeconds * 0.01;
        }

        // Stability slowly decays
        state.resources.stability -= elapsedSeconds * 0.005;

        // Clamp stability
        state.resources.stability = Math.max(
          0,
          Math.min(100, state.resources.stability)
        );

        state.meta.lastTick = now;
        state.stats.ticks += elapsedSeconds;
        state.stats.totalPlayTime += elapsedSeconds;

        return state;
      }

      /*************************************************
       * RENDER
       *************************************************/
      function render(state) {
        document.getElementById("output").innerText = `
ERA: ${state.realm.era}

RESOURCES
- Population : ${state.resources.population.toFixed(1)}
- Production : ${state.resources.production.toFixed(1)}
- Stability  : ${state.resources.stability.toFixed(1)}

BUILDINGS
- Settlement : ${state.buildings.settlement}
- Workshop   : ${state.buildings.workshop}
- Council    : ${state.buildings.council}

STATS
- Play time  : ${Math.floor(state.stats.totalPlayTime / 60)} min
- Ticks      : ${state.stats.ticks}
`;
      }

      /*************************************************
       * GAME LOOP
       *************************************************/
      let state = loadState();

      function gameLoop() {
        state = applyTime(state);
        saveState(state);
        render(state);
      }

      setInterval(gameLoop, 1000);
      render(state);

      /*************************************************
       * DEBUG / RESET
       *************************************************/
      function resetGame() {
        if (!confirm("Reset the world?")) return;
        localStorage.removeItem(STORAGE_KEY);
        state = structuredClone(DEFAULT_STATE);
        saveState(state);
        render(state);
      }
    </script>
  </body>
</html>
