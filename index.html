<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Idle Realm ‚Äì Pi Payments</title>

    <!-- Pi SDK -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
      Pi.init({ version: "2.0" });
    </script>

    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 30px;
      }
      button {
        padding: 12px 18px;
        margin-top: 10px;
        font-size: 16px;
      }
      #status {
        margin-top: 20px;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <h1>Idle Realm ‚Äì Pi Payment Test</h1>

    <button id="login">Login with Pi</button>
    <br />
    <button id="pay" disabled>Pay 1 Pi</button>

    <div id="status"></div>

    <script>
      let currentUser = null;

      const scopes = ["username", "payments"];
      const statusEl = document.getElementById("status");

      // LOGIN
      document.getElementById("login").onclick = async () => {
        statusEl.innerText = "Authenticating with Pi...";

        try {
          const auth = await Pi.authenticate(scopes, () => {});
          currentUser = auth.user;

          statusEl.innerText =
            "Logged in as " + currentUser.username;

          document.getElementById("pay").disabled = false;
        } catch (err) {
          console.error(err);
          statusEl.innerText = "Authentication failed";
        }
      };

      // PAYMENT
      document.getElementById("pay").onclick = async () => {
        statusEl.innerText = "Creating payment...";

        Pi.createPayment(
          {
            amount: 1,
            memo: "Idle Realm ‚Äì Test Payment",
            metadata: {
              app: "idle-realm",
              item: "starter_pack"
            }
          },
          {
            // üî• STEP 1 ‚Äî APPROVE (entro 60s)
            onReadyForServerApproval: async (paymentId) => {
              statusEl.innerText = "Approving payment...";

              await fetch("/api/pi", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  action: "approve",
                  paymentId
                })
              });
            },

            // üî• STEP 2 ‚Äî COMPLETE
            onReadyForServerCompletion: async (paymentId, txid) => {
              statusEl.innerText = "Completing payment...";

              await fetch("/api/pi", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  action: "complete",
                  paymentId,
                  txid
                })
              });
            },

            onComplete: (payment) => {
              console.log("Payment complete", payment);
              statusEl.innerText = "‚úÖ Payment successful!";
            },

            onCancel: () => {
              statusEl.innerText = "‚ùå Payment cancelled";
            },

            onError: (error) => {
              console.error(error);
              statusEl.innerText = "‚ö†Ô∏è Payment error";
            }
          }
        );
      };
    </script>
  </body>
</html>
