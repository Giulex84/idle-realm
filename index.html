<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Idle Realm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PI SDK (OBBLIGATORIO) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    Pi.init({ version: "2.0" });
  </script>

  <style>
    :root{
      --card:#141c33;
      --card2:#1b2546;
      --accent:#2f6bff;
      --text:#e6ecff;
      --muted:#9aa4c7;
      --ok:#22c55e;
    }
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto}
    body{margin:0;background:linear-gradient(180deg,#0a1020,#050a14);color:var(--text)}
    header{position:sticky;top:0;background:#060b18;padding:8px 12px;display:flex;gap:10px;font-size:13px}
    main{padding:16px;max-width:520px;margin:auto}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border-radius:16px;padding:16px;margin-bottom:16px}
    button{width:100%;border:none;border-radius:14px;padding:14px;margin-bottom:10px;background:var(--accent);color:#fff;font-size:16px;font-weight:600}
    button.bronze{background:linear-gradient(180deg,#e0a24c,#b87333)}
    .small{font-size:13px;color:var(--muted)}
    .ok{color:var(--ok)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .tile{background:#0f1730;border-radius:12px;height:72px;display:flex;align-items:center;justify-content:center;font-size:22px}
    .tiny{font-size:11px;color:#aab3ff;text-align:center;margin:20px 0}
  </style>
</head>

<body>
<header>
  <span>ğŸ‘¥ <b id="pop">0</b></span>
  <span>ğŸ› ï¸ <b id="prod">0</b></span>
  <span>ğŸ¥‰ <b id="bronze">0</b></span>
  <span>ğŸ›¡ï¸ <b id="stab">0</b>%</span>
  <span>â³ <b id="time">0</b></span>
</header>

<main>
  <h1>Idle Realm</h1>
  <div class="small">A living world shaped by time and choices</div>

  <!-- ERA -->
  <div class="card">
    <h2>Era</h2>
    <div id="eraTitle"></div>
    <div id="eraDesc" class="small"></div>
    <div id="objectives"></div>
    <button id="advanceEra" style="display:none"></button>
    <div id="resetEra" class="small">â†» restart era</div>
  </div>

  <!-- BUILD -->
  <div class="card">
    <h2>Build</h2>
    <button id="btnSettle">ğŸ  Settlement</button>
    <button id="btnWork">ğŸ› ï¸ Workshop</button>
    <button id="btnCouncil">ğŸ›ï¸ Council</button>
    <button id="btnCouncil2" style="display:none">ğŸ›ï¸ Council II (30 ğŸ¥‰)</button>
    <button id="btnCouncil3" style="display:none">ğŸ›ï¸ Council III (60 ğŸ¥‰)</button>
    <div class="small" id="info"></div>
  </div>

  <!-- CITY -->
  <div class="card">
    <h2>City</h2>
    <div class="grid" id="city"></div>
  </div>

  <!-- EVENTS + PI LOGIN -->
  <div class="card">
    <h2>Events</h2>

    <!-- PI LOGIN BUTTON (SEMPRE VISIBILE FINCHÃ‰ NON AUTENTICA) -->
    <button id="piLoginBtn">ğŸ” Login with Pi</button>

    <div id="events"></div>
    <div id="advisor" class="small"></div>
  </div>
</main>

<div class="tiny">
  <a href="privacy.html" target="_blank">Privacy Policy</a> â€¢
  <a href="terms.html" target="_blank">Terms of Service</a>
</div>

<script>
/* ================= CONFIG ================= */
const DEFAULT = {
  v:1,
  era:"foundations",
  pop:12,
  prod:30,
  bronze:0,
  stab:100,
  time:0,
  buildings:["ğŸ› ï¸"],
  councilLv:0,
  events:["Realm founded with basic craftsmanship"],
  piUser:null
};

/* ================= STATE ================= */
let state = load();
state.piUser = null; // ğŸ”´ NON fidarsi del localStorage per lâ€™auth

/* ================= PI AUTH ================= */
const PI_SCOPES = ["username"];

async function piLogin(){
  try{
    const auth = await Pi.authenticate(
      PI_SCOPES,
      payment => console.log("Incomplete payment", payment)
    );

    state.piUser = {
      uid: auth.user.uid,
      username: auth.user.username
    };

    log("Logged in as " + auth.user.username);
    document.getElementById("piLoginBtn").style.display = "none";
    update();
  }catch(err){
    console.error("Pi auth error", err);
    alert("Pi authentication failed");
  }
}

/* ================= HELPERS ================= */
function $(id){return document.getElementById(id);}
function log(t){state.events.unshift("â€¢ "+t);state.events=state.events.slice(0,10);}
function save(){localStorage.setItem("idleRealm",JSON.stringify(state));}
function load(){
  try{
    const s=JSON.parse(localStorage.getItem("idleRealm"));
    if(!s) throw 0;
    return Object.assign({},DEFAULT,s);
  }catch{
    return structuredClone(DEFAULT);
  }
}

/* ================= UPDATE ================= */
function update(){
  $("pop").textContent=state.pop;
  $("prod").textContent=state.prod.toFixed(1);
  $("bronze").textContent=state.bronze.toFixed(1);
  $("stab").textContent=Math.round(state.stab);
  $("time").textContent=state.time;

  $("eraTitle").textContent =
    state.era==="foundations"?"Foundations":
    state.era==="bronze"?"Bronze Age":"Iron Age";

  $("eraDesc").textContent =
    state.era==="foundations"?"Fast growth to learn the game.":
    state.era==="bronze"?"Governance stabilizes growing societies.":
    "Complex societies require long-term balance.";

  $("events").innerHTML = state.events.map(e=>`<div>${e}</div>`).join("");
  save();
}

/* ================= INIT ================= */
document.getElementById("piLoginBtn").onclick = piLogin;
update();
</script>
</body>
</html>
