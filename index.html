<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Pi SDK Baseline</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <h1>Pi SDK Baseline</h1>

  <button id="loginBtn">Login with Pi</button>
  <button id="payBtn" disabled>Pay 1 Pi</button>

  <p id="status"></p>

<script>
  Pi.init({ version: "2.0" });

  let user = null;

  document.getElementById("loginBtn").onclick = async () => {
    try {
      const auth = await Pi.authenticate(["username"], () => {});
      user = auth.user;
      document.getElementById("status").innerText =
        "Welcome: " + user.username;
      document.getElementById("payBtn").disabled = false;
    } catch (e) {
      document.getElementById("status").innerText = "Login failed";
    }
  };

  document.getElementById("payBtn").onclick = async () => {
    try {
      const payment = await Pi.createPayment({
        amount: 1,
        memo: "Idle Realm Test Payment",
        metadata: { reason: "test" }
      });

      // ðŸ”´ QUESTO Ãˆ IL PUNTO CRITICO
      await fetch("/api/pi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "approve",
          paymentId: payment.identifier
        })
      });

      document.getElementById("status").innerText =
        "Payment approved";
    } catch (e) {
      document.getElementById("status").innerText =
        "Payment failed";
    }
  };
</script>
</body>
</html>
