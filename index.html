<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Idle Realm</title>

  <!-- ================= PI SDK (NON TOCCARE) ================= -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    Pi.init({ version: "2.0" });
  </script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system;
      background: radial-gradient(circle at top, #0f172a, #020617);
      color: #e5e7eb;
    }

    header {
      padding: 20px;
      border-bottom: 1px solid #1f2937;
    }

    header h1 {
      margin: 0;
      font-size: 28px;
    }

    header p {
      margin: 4px 0 0;
      color: #9ca3af;
    }

    main {
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .panel {
      background: rgba(17, 24, 39, 0.9);
      border: 1px solid #1f2937;
      border-radius: 14px;
      padding: 16px;
    }

    h2 {
      margin-top: 0;
      font-size: 20px;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    button {
      background: #2563eb;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin: 4px 4px 0 0;
    }

    button:disabled {
      background: #374151;
    }

    /* ===== MAP ===== */
    .map {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 12px;
    }

    .tile {
      height: 56px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      background: #020617;
    }

    .tile.empty { background: #020617; }
    .tile.settlement { background: #1e293b; }
    .tile.workshop { background: #1f2937; }
    .tile.council { background: #312e81; }

    /* ===== EVENTS ===== */
    .event {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .choices button {
      background: #374151;
      font-size: 13px;
    }

    .era {
      font-size: 14px;
      color: #a5b4fc;
    }

    .meta {
      font-size: 14px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
<header>
  <h1>Idle Realm</h1>
  <p>A living world shaped by time and eras</p>
</header>

<main>
  <!-- REALM -->
  <div class="panel">
    <h2>Realm</h2>
    <div class="stat"><span>Era</span><span class="era" id="era"></span></div>
    <div class="stat"><span>Population</span><span id="population"></span></div>
    <div class="stat"><span>Production</span><span id="production"></span></div>
    <div class="stat"><span>Stability</span><span id="stability"></span></div>

    <h3>Build</h3>
    <button onclick="selectBuild('settlement')">üè† Settlement</button>
    <button onclick="selectBuild('workshop')">‚öí Workshop</button>
    <button onclick="selectBuild('council')">üèõ Council</button>
  </div>

  <!-- MAP -->
  <div class="panel">
    <h2>World Map</h2>
    <p class="meta">Click an empty tile to place the selected structure.</p>
    <div class="map" id="map"></div>
  </div>

  <!-- EVENTS -->
  <div class="panel">
    <h2>Events</h2>
    <div id="events"></div>
  </div>

  <!-- META -->
  <div class="panel">
    <h2>Meta</h2>
    <div class="stat"><span>Play time</span><span id="playtime"></span></div>
    <div class="stat"><span>Ticks</span><span id="ticks"></span></div>
    <button onclick="resetGame()">Reset World</button>
  </div>
</main>

<script>
/* ============================================================
   STATE & ERAS
============================================================ */
const STORAGE_KEY = "idle_realm_save";

const ERAS = [
  {
    name: "Foundations",
    rules: {
      popGrowth: 0.01,
      prodBonus: 1.0,
      stabilityDecay: 0.004
    },
    unlockAtPop: 0
  },
  {
    name: "Expansion",
    rules: {
      popGrowth: 0.015,
      prodBonus: 1.2,
      stabilityDecay: 0.006
    },
    unlockAtPop: 30
  },
  {
    name: "Crisis",
    rules: {
      popGrowth: 0.005,
      prodBonus: 0.9,
      stabilityDecay: 0.01
    },
    unlockAtPop: 80
  }
];

const DEFAULT_STATE = {
  meta: {
    version: 1,
    createdAt: Date.now(),
    lastTick: Date.now()
  },
  eraIndex: 0,
  resources: {
    population: 10,
    production: 20,
    stability: 70
  },
  buildings: {
    settlement: 1,
    workshop: 0,
    council: 0
  },
  map: Array(49).fill(null),
  events: [],
  stats: {
    playTime: 0,
    ticks: 0
  }
};

const BUILD_DATA = {
  settlement: { cost: 25, stability: 2, icon: "üè†" },
  workshop: { cost: 40, stability: 4, icon: "‚öí" },
  council: { cost: 60, stability: 0, icon: "üèõ" }
};

let selectedBuild = null;

/* ============================================================
   LOAD / SAVE
============================================================ */
function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return structuredClone(DEFAULT_STATE);
  try { return JSON.parse(raw); }
  catch { return structuredClone(DEFAULT_STATE); }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ============================================================
   GAME LOGIC
============================================================ */
function updateEra() {
  for (let i = ERAS.length - 1; i >= 0; i--) {
    if (state.resources.population >= ERAS[i].unlockAtPop) {
      state.eraIndex = i;
      break;
    }
  }
}

function applyTime() {
  const now = Date.now();
  const elapsed = Math.min(
    Math.floor((now - state.meta.lastTick) / 1000),
    86400
  );
  if (elapsed <= 0) return;

  const era = ERAS[state.eraIndex].rules;

  const prodRate =
    state.resources.population * 0.1 *
    era.prodBonus +
    state.buildings.workshop * 0.6;

  state.resources.production += prodRate * elapsed;

  if (state.resources.stability > 40) {
    state.resources.population += elapsed * era.popGrowth;
  }

  state.resources.stability +=
    state.buildings.council * 0.002 * elapsed;

  state.resources.stability -=
    elapsed * era.stabilityDecay;

  state.resources.stability = Math.max(
    0, Math.min(100, state.resources.stability)
  );

  if (Math.random() < elapsed * 0.00015) {
    createEvent();
  }

  updateEra();

  state.meta.lastTick = now;
  state.stats.playTime += elapsed;
  state.stats.ticks += elapsed;
}

/* ============================================================
   EVENTS
============================================================ */
function createEvent() {
  const unstable = state.resources.stability < 40;

  const event = unstable
    ? {
        text: "Riots erupt in the outer districts.",
        choices: [
          { label: "Send guards", effect() { state.resources.stability += 5; } },
          { label: "Let it burn", effect() { state.resources.population -= 1; } }
        ]
      }
    : {
        text: "Trade caravans bring prosperity.",
        choices: [
          { label: "Tax trade", effect() { state.resources.production += 15; } },
          { label: "Encourage migration", effect() { state.resources.population += 2; } }
        ]
      };

  state.events.unshift(event);
  state.events = state.events.slice(0, 4);
}

/* ============================================================
   BUILDING & MAP
============================================================ */
function selectBuild(type) {
  selectedBuild = type;
}

function placeBuilding(index) {
  if (!selectedBuild) return;
  if (state.map[index]) return;

  const b = BUILD_DATA[selectedBuild];
  if (
    state.resources.production < b.cost ||
    state.resources.stability < b.stability
  ) return;

  state.resources.production -= b.cost;
  state.resources.stability -= b.stability;

  state.map[index] = selectedBuild;
  state.buildings[selectedBuild]++;
  selectedBuild = null;
}

/* ============================================================
   RENDER
============================================================ */
function render() {
  document.getElementById("era").innerText =
    ERAS[state.eraIndex].name;

  document.getElementById("population").innerText =
    state.resources.population.toFixed(1);
  document.getElementById("production").innerText =
    state.resources.production.toFixed(1);
  document.getElementById("stability").innerText =
    state.resources.stability.toFixed(1);

  document.getElementById("playtime").innerText =
    Math.floor(state.stats.playTime / 60) + " min";
  document.getElementById("ticks").innerText =
    state.stats.ticks;

  const mapEl = document.getElementById("map");
  mapEl.innerHTML = "";
  state.map.forEach((cell, i) => {
    const d = document.createElement("div");
    d.className = "tile " + (cell || "empty");
    d.innerText = cell ? BUILD_DATA[cell].icon : "";
    d.onclick = () => placeBuilding(i);
    mapEl.appendChild(d);
  });

  const ev = document.getElementById("events");
  ev.innerHTML = "";
  state.events.forEach(e => {
    const d = document.createElement("div");
    d.className = "event";
    d.innerHTML = `<p>${e.text}</p>`;
    const c = document.createElement("div");
    c.className = "choices";
    e.choices.forEach(ch => {
      const b = document.createElement("button");
      b.innerText = ch.label;
      b.onclick = () => {
        ch.effect();
        state.events = state.events.filter(x => x !== e);
        saveState();
        render();
      };
      c.appendChild(b);
    });
    d.appendChild(c);
    ev.appendChild(d);
  });
}

/* ============================================================
   INIT
============================================================ */
let state = loadState();

function loop() {
  applyTime();
  saveState();
  render();
}

setInterval(loop, 1000);
render();

/* ============================================================
   RESET
============================================================ */
function resetGame() {
  if (!confirm("Reset the realm?")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = structuredClone(DEFAULT_STATE);
  saveState();
  render();
}
</script>
</body>
</html>
