<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Idle Realm</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:radial-gradient(circle at top,#1b2a4a,#050914);
  color:#e5e7eb;
}
header{
  padding:10px;
  display:flex;
  justify-content:space-around;
  background:#050914;
  font-size:14px;
}
.container{padding:16px;max-width:420px;margin:auto}
h1{margin:8px 0 0;font-size:30px}
.subtitle{opacity:.7;margin-bottom:16px}
.card{
  background:rgba(255,255,255,.06);
  border-radius:16px;
  padding:16px;
  margin-bottom:18px;
}
button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:14px;
  font-size:16px;
  background:#2563eb;
  color:white;
}
button:disabled{opacity:.4}
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}
.tile{
  height:70px;
  border-radius:14px;
  background:rgba(255,255,255,.08);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
}
.log{font-size:14px;opacity:.85}
.cooldown{color:#facc15;font-weight:600}
.objective{font-size:14px}
.objective.done{color:#22c55e}
.locked{opacity:.5}
</style>
</head>

<body>

<header>
  üë• <span id="pop"></span>
  ‚öíÔ∏è <span id="prod"></span>
  üõ°Ô∏è <span id="stab"></span>%
  ‚è≥ <span id="time"></span>
</header>

<div class="container">
<h1>Idle Realm</h1>
<div class="subtitle">A living world shaped by time and choices</div>

<div class="card">
<h2>Build</h2>
<button id="bSettlement">üè† Settlement</button>
<button id="bWorkshop">üõ† Workshop</button>
<button id="bCouncil">üèõ Council</button>
<div id="cooldown" class="cooldown"></div>
</div>

<div class="card">
<h2>City</h2>
<div id="city" class="grid"></div>
</div>

<div class="card">
<h2>Era</h2>
<div id="eraText"></div>
<div id="objectives"></div>
</div>

<div class="card">
<h2>Events</h2>
<div id="events" class="log"></div>
</div>

<div class="card">
<h2>Realm Chronicle</h2>
<div id="chronicle" class="log"></div>
</div>
</div>

<script>
/* ================= STATE ================= */
let S = {
  era: 1,
  population: 10,
  production: 30,
  totalProduction: 0,
  stability: 100,
  time: 0,

  settlements: 0,
  workshops: 0,
  council: false,

  citySize: 9,
  city: Array(9).fill(null),

  cooldown: 0,
  cooldownMax: 8
};

/* ================= PERSISTENCE ================= */
const SAVE_KEY = "idle_realm_save";

function saveGame(){
  localStorage.setItem(SAVE_KEY, JSON.stringify(S));
}
function loadGame(){
  const data = localStorage.getItem(SAVE_KEY);
  if(data){
    S = JSON.parse(data);
  }
}

/* ================= TEXT ================= */
const chronicles = {
  1:[
    "Small clans gather around fire and stone.",
    "Growth is fast, but fragile.",
    "The first settlements define survival."
  ],
  2:[
    "Bronze reshapes tools and power.",
    "Progress slows, choices deepen.",
    "Metal binds the fate of nations."
  ]
};

let chronicleIndex = 0;

/* ================= HELPERS ================= */
const $=id=>document.getElementById(id);
const log=t=>{$("events").innerHTML="‚Ä¢ "+t+"<br>"+$("events").innerHTML;}
function emptySlot(){return S.city.findIndex(t=>t===null);}

/* ================= UI ================= */
function renderCity(){
  $("city").innerHTML="";
  S.city.forEach(t=>{
    const d=document.createElement("div");
    d.className="tile";
    d.textContent=t||"";
    $("city").appendChild(d);
  });
}

function updateChronicle(){
  const arr=chronicles[S.era];
  $("chronicle").textContent=arr[chronicleIndex];
  chronicleIndex=(chronicleIndex+1)%arr.length;
}

function updateObjectives(){
  let html="";
  if(S.era===1){
    const o1 = S.settlements + S.workshops + (S.council?1:0) >= 5 && S.workshops>=1;
    const o2 = S.population>=35 && S.stability>=60;
    const o3 = S.totalProduction>=100;

    html += `<div class="objective ${o1?'done':''}">‚Ä¢ Build 5 buildings (1 Workshop)</div>`;
    html += `<div class="objective ${o2?'done':''}">‚Ä¢ Reach 35 population (60% stability)</div>`;
    html += `<div class="objective ${o3?'done':''}">‚Ä¢ Accumulate 100 production</div>`;

    if(o1 && o2 && o3){
      advanceEra();
    }
  }
  $("objectives").innerHTML=html;
}

function updateUI(){
  $("pop").textContent=S.population.toFixed(1);
  $("prod").textContent=S.production.toFixed(1);
  $("stab").textContent=Math.max(0,Math.min(100,S.stability)).toFixed(0);
  $("time").textContent=S.time;

  $("bSettlement").disabled=!canBuild("settlement");
  $("bWorkshop").disabled=!canBuild("workshop");
  $("bCouncil").disabled=!canBuild("council");

  $("cooldown").textContent=S.cooldown>0?`Cooldown: ${S.cooldown}s`:"";

  $("eraText").innerHTML=
    S.era===1
    ? "<b>Age of Clans</b><br>Fast growth. Learning phase."
    : "<b>Age of Bronze</b><br>Slower progress. Strategic depth.";

  renderCity();
  updateObjectives();
}

/* ================= ECONOMY ================= */
function prodPerSecond(){
  if(S.era===1){
    return 0.2 + S.workshops*0.6;
  }
  return 0.1 + Math.pow(S.workshops,0.8)*0.5;
}

/* ================= BUILD ================= */
function canBuild(type){
  if(S.cooldown>0) return false;
  if(emptySlot()<0) return false;

  if(type==="settlement") return S.production>=15;
  if(type==="workshop") return S.production>=20;
  if(type==="council") return S.production>=30 && !S.council;
  return false;
}

function build(type){
  if(!canBuild(type)) return;
  const slot=emptySlot();
  S.cooldown=S.cooldownMax;

  if(type==="settlement"){
    S.production-=15;
    S.population+=S.era===1?4:2;
    S.stability-=6;
    S.settlements++;
    S.city[slot]="üè†";
    log("Settlement expands population");
  }
  if(type==="workshop"){
    S.production-=20;
    S.workshops++;
    S.stability-=4;
    S.city[slot]="üõ†";
    log("Workshop improves production");
  }
  if(type==="council"){
    S.production-=30;
    S.stability+=20;
    S.council=true;
    S.city[slot]="üèõ";
    log("Council brings order");
  }
  saveGame();
  updateUI();
}

/* ================= ERA TRANSITION ================= */
function advanceEra(){
  if(S.era!==1) return;
  S.era=2;
  S.citySize=12;
  S.city.push(null,null,null);
  S.cooldownMax=12;
  log("‚öîÔ∏è The Age of Bronze begins!");
  updateChronicle();
  saveGame();
}

/* ================= BUTTONS ================= */
bSettlement.onclick=()=>build("settlement");
bWorkshop.onclick=()=>build("workshop");
bCouncil.onclick=()=>build("council");

/* ================= TICK ================= */
setInterval(()=>{
  S.time++;
  const p=prodPerSecond();
  S.production+=p;
  S.totalProduction+=p;
  if(S.cooldown>0) S.cooldown--;
  if(S.time%10===0) updateChronicle();
  saveGame();
  updateUI();
},1000);

/* ================= INIT ================= */
loadGame();
updateChronicle();
updateUI();
renderCity();
</script>

</body>
</html>
