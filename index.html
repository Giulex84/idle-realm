<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Idle Realm</title>

  <!-- ================= PI SDK (NON TOCCARE) ================= -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    Pi.init({ version: "2.0" });
  </script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system;
      background: radial-gradient(circle at top, #0f172a, #020617);
      color: #e5e7eb;
    }

    header {
      padding: 20px;
      border-bottom: 1px solid #1f2937;
    }

    header h1 {
      margin: 0;
      font-size: 28px;
    }

    header p {
      margin: 4px 0 0;
      color: #9ca3af;
    }

    main {
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .panel {
      background: rgba(17, 24, 39, 0.85);
      border: 1px solid #1f2937;
      border-radius: 14px;
      padding: 16px;
    }

    h2 {
      margin-top: 0;
      font-size: 20px;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .good { color: #4ade80; }
    .bad { color: #f87171; }

    button {
      background: #2563eb;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin: 4px 4px 0 0;
    }

    button:disabled {
      background: #374151;
      cursor: not-allowed;
    }

    /* ===== CITY GRID ===== */
    .city {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin-top: 12px;
    }

    .tile {
      height: 56px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .settlement { background: #1e293b; }
    .workshop { background: #1f2937; }
    .council { background: #312e81; }

    /* ===== EVENTS ===== */
    .event {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .choices button {
      background: #374151;
      font-size: 13px;
    }

    .meta {
      font-size: 14px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
<header>
  <h1>Idle Realm</h1>
  <p>A living world that grows with time</p>
</header>

<main>
  <!-- ===== REALM ===== -->
  <div class="panel">
    <h2>Realm</h2>
    <div class="stat"><span>Era</span><span id="era"></span></div>
    <div class="stat"><span>Population</span><span id="population"></span></div>
    <div class="stat"><span>Production</span><span id="production"></span></div>
    <div class="stat"><span>Stability</span><span id="stability"></span></div>

    <h3>Build</h3>
    <button onclick="build('settlement')">üè† Settlement</button>
    <button onclick="build('workshop')">‚öí Workshop</button>
    <button onclick="build('council')">üèõ Council</button>
  </div>

  <!-- ===== CITY ===== -->
  <div class="panel">
    <h2>City</h2>
    <p class="meta">Each tile represents a real structure in your realm.</p>
    <div class="city" id="city"></div>
  </div>

  <!-- ===== EVENTS ===== -->
  <div class="panel">
    <h2>Events</h2>
    <div id="events"></div>
  </div>

  <!-- ===== META ===== -->
  <div class="panel">
    <h2>Meta</h2>
    <div class="stat"><span>Play time</span><span id="playtime"></span></div>
    <div class="stat"><span>Ticks</span><span id="ticks"></span></div>
    <button onclick="resetGame()">Reset World</button>
  </div>
</main>

<script>
/* ============================================================
   STATE
============================================================ */
const STORAGE_KEY = "idle_realm_save";

const DEFAULT_STATE = {
  meta: {
    version: 1,
    createdAt: Date.now(),
    lastTick: Date.now()
  },
  realm: {
    era: "Foundations"
  },
  resources: {
    population: 10,
    production: 20,
    stability: 70
  },
  buildings: {
    settlement: 1,
    workshop: 0,
    council: 0
  },
  city: [],
  events: [],
  stats: {
    playTime: 0,
    ticks: 0
  }
};

const BUILD_COST = {
  settlement: { production: 25, stability: 2, icon: "üè†" },
  workshop: { production: 40, stability: 4, icon: "‚öí" },
  council: { production: 60, stability: 0, icon: "üèõ" }
};

/* ============================================================
   LOAD / SAVE
============================================================ */
function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return structuredClone(DEFAULT_STATE);
  try { return JSON.parse(raw); }
  catch { return structuredClone(DEFAULT_STATE); }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ============================================================
   GAME LOOP
============================================================ */
function applyTime() {
  const now = Date.now();
  const elapsed = Math.min(
    Math.floor((now - state.meta.lastTick) / 1000),
    86400
  );
  if (elapsed <= 0) return;

  const prodRate =
    state.resources.population * 0.1 +
    state.buildings.workshop * 0.6;

  state.resources.production += prodRate * elapsed;

  if (state.resources.stability > 50) {
    state.resources.population += elapsed * 0.01;
  }

  state.resources.stability +=
    state.buildings.council * 0.002 * elapsed;

  state.resources.stability -=
    elapsed * (0.004 + state.buildings.workshop * 0.001);

  state.resources.stability = Math.max(
    0, Math.min(100, state.resources.stability)
  );

  if (Math.random() < elapsed * 0.00015) {
    createEvent();
  }

  state.meta.lastTick = now;
  state.stats.playTime += elapsed;
  state.stats.ticks += elapsed;
}

/* ============================================================
   EVENTS WITH CHOICES
============================================================ */
function createEvent() {
  const bad = state.resources.stability < 40;

  const event = bad
    ? {
        text: "Unrest spreads among the population.",
        choices: [
          {
            label: "Suppress dissent",
            effect() { state.resources.stability += 5; }
          },
          {
            label: "Ignore it",
            effect() { state.resources.stability -= 5; }
          }
        ]
      }
    : {
        text: "A calm period strengthens social cohesion.",
        choices: [
          {
            label: "Encourage growth",
            effect() { state.resources.population += 1; }
          },
          {
            label: "Stockpile resources",
            effect() { state.resources.production += 10; }
          }
        ]
      };

  state.events.unshift(event);
  state.events = state.events.slice(0, 5);
}

/* ============================================================
   BUILDINGS
============================================================ */
function build(type) {
  const cost = BUILD_COST[type];
  if (
    state.resources.production < cost.production ||
    state.resources.stability < cost.stability
  ) return;

  state.resources.production -= cost.production;
  state.resources.stability -= cost.stability;
  state.buildings[type]++;
  state.city.push(type);
  createEvent();
}

/* ============================================================
   RENDER
============================================================ */
function render() {
  document.getElementById("era").innerText = state.realm.era;
  document.getElementById("population").innerText =
    state.resources.population.toFixed(1);
  document.getElementById("production").innerText =
    state.resources.production.toFixed(1);
  document.getElementById("stability").innerText =
    state.resources.stability.toFixed(1);

  document.getElementById("playtime").innerText =
    Math.floor(state.stats.playTime / 60) + " min";
  document.getElementById("ticks").innerText = state.stats.ticks;

  const city = document.getElementById("city");
  city.innerHTML = "";
  state.city.forEach(type => {
    const tile = document.createElement("div");
    tile.className = "tile " + type;
    tile.innerText = BUILD_COST[type].icon;
    city.appendChild(tile);
  });

  const ev = document.getElementById("events");
  ev.innerHTML = "";
  state.events.forEach(e => {
    const d = document.createElement("div");
    d.className = "event";
    d.innerHTML = `<p>${e.text}</p>`;
    const c = document.createElement("div");
    c.className = "choices";
    e.choices.forEach(ch => {
      const b = document.createElement("button");
      b.innerText = ch.label;
      b.onclick = () => {
        ch.effect();
        state.events = state.events.filter(x => x !== e);
        saveState();
        render();
      };
      c.appendChild(b);
    });
    d.appendChild(c);
    ev.appendChild(d);
  });
}

/* ============================================================
   INIT
============================================================ */
let state = loadState();

function loop() {
  applyTime();
  saveState();
  render();
}

setInterval(loop, 1000);
render();

/* ============================================================
   RESET
============================================================ */
function resetGame() {
  if (!confirm("Reset the realm?")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = structuredClone(DEFAULT_STATE);
  saveState();
  render();
}
</script>
</body>
</html>
