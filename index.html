<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pi SDK Baseline</title>

  <!-- Pi SDK (OBBLIGATORIO) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <script>
    let user = null;

    // INIT SDK (OBBLIGATORIO)
    document.addEventListener("DOMContentLoaded", () => {
      if (!window.Pi) {
        alert("Pi SDK not loaded. Use Pi Browser.");
        return;
      }

      Pi.init({
        version: "2.0",
        sandbox: false
      });
    });

    // LOGIN
    function loginWithPi() {
      Pi.authenticate(
        ["username"],
        function (auth) {
          user = auth.user;
          document.getElementById("status").innerText =
            "Welcome: " + user.username;
        },
        function (error) {
          console.error("Auth error:", error);
          alert("Authentication failed");
        }
      );
    }

    // PAYMENT
    function payOnePi() {
      if (!user) {
        alert("Login first");
        return;
      }

      Pi.createPayment(
        {
          amount: 1,
          memo: "Test payment",
          metadata: { app: "idle-realm" }
        },
        {
          onReadyForServerApproval(paymentId) {
            fetch("/api/pi", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "approve",
                paymentId
              })
            });
          },

          onReadyForServerCompletion(paymentId, txid) {
            fetch("/api/pi", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "complete",
                paymentId,
                txid
              })
            });
          },

          onCancel(paymentId) {
            console.log("Payment cancelled:", paymentId);
          },

          onError(error, payment) {
            console.error("Payment error:", error, payment);
            alert("Payment error");
          }
        }
      );
    }
  </script>
</head>

<body>
  <h1>Pi SDK Baseline</h1>

  <button onclick="loginWithPi()">Login with Pi</button>
  <button onclick="payOnePi()">Pay 1 Pi</button>

  <p id="status"></p>
</body>
</html>
