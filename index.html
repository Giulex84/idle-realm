<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Idle Realm</title>

<style>
:root{
  --card:#141c33;
  --card2:#1b2546;
  --accent:#2f6bff;
  --bronze:#c27c2c;
  --iron:#9aa0a6;
  --text:#e6ecff;
  --muted:#9aa4c7;
  --ok:#22c55e;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto}
body{margin:0;background:linear-gradient(180deg,#0a1020,#050a14);color:var(--text)}
header{
  position:sticky;top:0;z-index:10;
  background:#060b18;
  padding:8px 12px;
  display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;
  font-size:14px;
}
main{padding:16px;max-width:500px;margin:auto}
.card{background:linear-gradient(180deg,var(--card),var(--card2));border-radius:16px;padding:16px;margin-bottom:16px}
button{width:100%;border:none;border-radius:14px;padding:14px;margin-bottom:10px;background:var(--accent);color:white;font-size:16px}
button.bronze{background:linear-gradient(180deg,#e0a24c,#b87328);color:#1a0f00;font-weight:600}
button.iron{background:linear-gradient(180deg,#cfd4da,#7b8188);color:#0b0f14;font-weight:600}
button:disabled{opacity:.4}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.tile{background:#0f1730;border-radius:12px;height:70px;display:flex;align-items:center;justify-content:center;font-size:26px}
.small{font-size:13px;color:var(--muted)}
.obj{font-size:14px;margin-bottom:4px}
.obj.ok{color:var(--ok)}
.advisor{font-size:12px;color:#aab3ff;margin-top:10px;text-align:center}
</style>
</head>

<body>

<header>
  <span>ğŸ‘¥ <b id="pop"></b></span>
  <span>âš’ï¸ <b id="prod"></b></span>
  <span>ğŸ¥‰ <b id="bronze"></b></span>
  <span>ğŸ›¡ï¸ <b id="stab"></b>%</span>
  <span>â³ <b id="time"></b></span>
</header>

<main>
<h1>Idle Realm</h1>
<div class="small">A living world shaped by time and choices</div>

<div class="card">
  <h2>Era</h2>
  <div id="eraTitle"></div>
  <div id="eraDesc" class="small"></div>
  <div id="objectives"></div>
  <button id="advanceEra" style="display:none"></button>
</div>

<div class="card">
  <h2>Build</h2>
  <button id="btnSettle">ğŸ  Settlement</button>
  <button id="btnWork">âš’ï¸ Workshop</button>
  <button id="btnCouncil">ğŸ›ï¸ Council</button>
  <button id="btnCouncil2" style="display:none">ğŸ›ï¸ Council II (30 ğŸ¥‰)</button>
  <button id="btnMine" style="display:none">â›ï¸ Mine</button>

  <button id="btnBarracks" style="display:none">âš”ï¸ Barracks</button>
  <button id="btnForge" style="display:none">ğŸ—ï¸ Forge</button>
  <button id="btnArchive" style="display:none">ğŸ“œ Archive</button>

  <div class="small" id="info"></div>
</div>

<div class="card">
  <h2>City</h2>
  <div class="grid" id="city"></div>
</div>

<div class="card">
  <h2>Events</h2>
  <div id="events"></div>
  <div class="advisor" id="advisor"></div>
</div>
</main>

<script>
/* ===== CONFIG ===== */
const SLOT_BY_ERA = { foundations:9, bronze:12, iron:15 };
const COOLDOWN = 8;
const ERA2_COST = 50;
const ERA3_COST = 75;

const COST = {
  settlement:15,
  workshop:20,
  council:30,
  mine:25,
  barracks:35,
  forge:45,
  archive:40
};

const DEFAULT = {
  v:8,
  era:"foundations",
  pop:12,
  prod:30,
  bronze:0,
  stab:100,
  time:0,
  lastAction:0,
  lastChange:Date.now(),
  lastSeen:Date.now(),
  buildings:["âš’ï¸"],
  councilLv:0,
  objTime:[0,0,0],
  events:["â€¢ Realm founded with basic craftsmanship"]
};

let state = load();

/* ===== HELPERS ===== */
function $(id){return document.getElementById(id);}
function clamp(){
  state.pop=Math.max(0,state.pop);
  state.prod=Math.max(0,state.prod);
  state.bronze=Math.max(0,state.bronze);
  state.stab=Math.max(0,Math.min(100,state.stab));
}
function maxSlots(){ return SLOT_BY_ERA[state.era]; }

/* ===== LOAD / SAVE ===== */
function load(){
  try{
    const s=JSON.parse(localStorage.getItem("idleRealm"));
    if(!s||s.v!==DEFAULT.v) throw 0;
    return Object.assign(structuredClone(DEFAULT),s);
  }catch{
    localStorage.removeItem("idleRealm");
    return structuredClone(DEFAULT);
  }
}
function save(){
  state.lastSeen=Date.now();
  localStorage.setItem("idleRealm",JSON.stringify(state));
}
function canAct(){return Date.now()-state.lastAction>=COOLDOWN*1000;}
function log(msg){
  state.events.unshift("â€¢ "+msg);
  state.events=state.events.slice(0,10);
}

/* ===== OBJECTIVES ===== */
function eraObjectives(){
  if(state.era==="foundations"){
    return [
      ["Build 3 Settlements",state.buildings.filter(b=>b==="ğŸ ").length>=3],
      ["Reach 50 Production",state.prod>=50],
      ["Establish the Council",state.councilLv>=1],
      ["Stability â‰¥ 70%",state.stab>=70]
    ];
  }
  if(state.era==="bronze"){
    return [
      ["Stability â‰¥ 75% (sustained)",state.objTime[0]>=300],
      ["Bronze â‰¥ 75",state.bronze>=75],
      ["Council II established",state.councilLv===2]
    ];
  }
  return [
    ["Reach Population 50",state.pop>=50],
    ["Build 2 Forges",state.buildings.filter(b=>b==="ğŸ—ï¸").length>=2],
    ["Stability â‰¥ 80% (5 min)",state.objTime[1]>=300],
    ["Stability â‰¥ 90% (10 min)",state.objTime[2]>=600]
  ];
}

/* ===== UPDATE ===== */
function update(){
  $("pop").innerText=state.pop;
  $("prod").innerText=state.prod.toFixed(1);
  $("bronze").innerText=state.bronze.toFixed(1);
  $("stab").innerText=Math.round(state.stab);
  $("time").innerText=state.time;

  $("eraTitle").innerHTML="<b>"+state.era.toUpperCase()+"</b>";
  $("eraDesc").innerText=
    state.era==="foundations"?"Fast growth to understand the game.":
    state.era==="bronze"?"Governance stabilizes growing societies.":
    "Power demands structure.";

  $("advanceEra").style.display=
    state.era!=="iron"&&eraObjectives().every(o=>o[1])?"block":"none";
  $("advanceEra").className=state.era==="bronze"?"iron":"bronze";
  $("advanceEra").innerText=
    state.era==="foundations"?"ğŸ¥‰ Enter the Bronze Age (50 âš’ï¸)":
    "âš”ï¸ Enter the Iron Age (75 ğŸ¥‰)";

  $("btnMine").style.display=$("btnCouncil2").style.display=
    state.era==="bronze"?"block":"none";

  const iron=state.era==="iron";
  $("btnBarracks").style.display=
  $("btnForge").style.display=
  $("btnArchive").style.display=iron?"block":"none";

  $("objectives").innerHTML="";
  eraObjectives().forEach(o=>{
    const d=document.createElement("div");
    d.className="obj"+(o[1]?" ok":"");
    d.innerText=(o[1]?"âœ” ":"â˜ ")+o[0];
    $("objectives").appendChild(d);
  });

  $("city").innerHTML="";
  for(let i=0;i<maxSlots();i++){
    const t=document.createElement("div");
    t.className="tile";
    t.innerText=state.buildings[i]||"â¬œ";
    t.onclick=()=>remove(i);
    $("city").appendChild(t);
  }

  $("advisor").innerText=advisorText();
  $("events").innerHTML=state.events.map(e=>`<div>${e}</div>`).join("");
  save();
}

/* ===== ACTIONS ===== */
function act(){state.lastAction=Date.now();state.lastChange=Date.now();}
function build(type,icon){
  if(!canAct()||state.prod<COST[type]||state.buildings.length>=maxSlots()) return;
  if(type==="council" && state.councilLv>0) return;

  state.prod-=COST[type];

  if(type==="council"){
    state.councilLv=1;
    state.buildings.push("ğŸ›ï¸");
    state.stab+=15;
  }else{
    state.buildings.push(icon);
  }

  if(type==="settlement"){state.pop+=4;state.stab-=6;}

  clamp();log(icon+" constructed");act();update();
}
function remove(i){
  const b=state.buildings[i];
  if(!b) return;
  state.buildings.splice(i,1);
  if(b==="ğŸ ") state.pop=Math.max(0,state.pop-4);
  if(b==="ğŸ›ï¸") state.councilLv=0;
  clamp();log(b+" removed");act();update();
}

/* ===== BUTTONS ===== */
$("btnSettle").onclick=()=>build("settlement","ğŸ ");
$("btnWork").onclick=()=>build("workshop","âš’ï¸");
$("btnCouncil").onclick=()=>build("council","ğŸ›ï¸");
$("btnMine").onclick=()=>build("mine","â›ï¸");
$("btnBarracks").onclick=()=>build("barracks","âš”ï¸");
$("btnForge").onclick=()=>build("forge","ğŸ—ï¸");
$("btnArchive").onclick=()=>build("archive","ğŸ“œ");

$("btnCouncil2").onclick=()=>{
  if(!canAct()||state.councilLv!==1||state.bronze<30) return;
  const idx=state.buildings.indexOf("ğŸ›ï¸");
  if(idx!==-1) state.buildings[idx]="ğŸ›ï¸";
  state.councilLv=2;
  state.bronze-=30;
  clamp();log("Council II established");act();update();
};

/* ===== ERA TRANSITION ===== */
$("advanceEra").onclick=()=>{
  if(state.era==="foundations"&&state.prod>=ERA2_COST){
    state.prod-=ERA2_COST;state.era="bronze";
    log("The Bronze Age begins");
  }else if(state.era==="bronze"&&state.bronze>=ERA3_COST){
    state.bronze-=ERA3_COST;state.era="iron";
    log("The Iron Age begins");
  }
  act();clamp();update();
};

/* ===== TICK ===== */
setInterval(()=>{
  try{
    state.time++;

    const w=state.buildings.filter(b=>b==="âš’ï¸").length;
    const m=state.buildings.filter(b=>b==="â›ï¸").length;
    const f=state.buildings.filter(b=>b==="ğŸ—ï¸").length;
    const bks=state.buildings.filter(b=>b==="âš”ï¸").length;
    const arc=state.buildings.filter(b=>b==="ğŸ“œ").length;

    state.prod+=w*0.22+f*0.18;
    state.bronze+=m*0.05;

    /* === GOVERNANCE RECOVERY === */
    if(state.era==="bronze"){
      if(state.pop>=32) state.stab+=0.09;
      else if(state.pop>=30) state.stab+=0.05;
    }
    if(state.era==="iron"){
      if(state.pop>=40) state.stab+=0.08;
      else if(state.pop>=30) state.stab+=0.04;
    }

    let pressure=Math.max(0,(w+m+f)-3);
    if(state.era==="iron") pressure+=Math.floor(state.pop/20);
    if(bks>0) pressure=Math.max(0,pressure-bks);

    if(pressure>0) state.stab-=pressure*0.06;
    if(arc>0) state.stab+=arc*0.04;
    if(state.stab<100) state.stab+=0.02;

    if(state.era==="bronze"&&state.stab>=75) state.objTime[0]++;
    if(state.era==="iron"&&state.stab>=80) state.objTime[1]++;
    if(state.era==="iron"&&state.stab>=90) state.objTime[2]++;

    clamp();update();
  }catch(e){
    log("JS error");
  }
},1000);

function advisorText(){
  if(state.era==="iron") return "Power must be organized, not accumulated.";
  if(state.pop<20) return "A young society struggles to govern itself.";
  if(state.pop<30) return "Population absorbs pressure, but growth is fragile.";
  if(state.stab<75) return "Governance requires patience.";
  return "The realm is stable and resilient.";
}

update();
</script>
</body>
</html>
