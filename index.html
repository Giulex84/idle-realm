<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Idle Realm</title>

  <!-- ================= PI SDK (NON TOCCARE) ================= -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    Pi.init({ version: "2.0" });
  </script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system;
      background: #0b0e14;
      color: #e6e6e6;
    }

    header {
      padding: 16px;
      background: #111827;
      border-bottom: 1px solid #1f2937;
    }

    main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 16px;
    }

    .panel {
      background: #111827;
      border-radius: 10px;
      padding: 16px;
      border: 1px solid #1f2937;
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    button {
      background: #2563eb;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 6px;
      margin-right: 6px;
    }

    button:disabled {
      background: #374151;
      cursor: not-allowed;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .good { color: #4ade80; }
    .bad { color: #f87171; }

    .log {
      font-size: 13px;
      max-height: 200px;
      overflow-y: auto;
      background: #020617;
      padding: 8px;
      border-radius: 6px;
    }

    .city {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin-top: 12px;
    }

    .tile {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 6px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
  </style>
</head>

<body>
<header>
  <h1>Idle Realm</h1>
  <p>A living world that grows with time</p>
</header>

<main>
  <div class="panel">
    <h2>Realm</h2>
    <div class="stat"><span>Era</span><span id="era"></span></div>
    <div class="stat"><span>Population</span><span id="population"></span></div>
    <div class="stat"><span>Production</span><span id="production"></span></div>
    <div class="stat"><span>Stability</span><span id="stability"></span></div>

    <h3>Build</h3>
    <button onclick="build('settlement')">Settlement</button>
    <button onclick="build('workshop')">Workshop</button>
    <button onclick="build('council')">Council</button>
  </div>

  <div class="panel">
    <h2>City View (prototype)</h2>
    <p style="font-size:13px;color:#9ca3af">
      This is the foundation for future visuals.
    </p>
    <div class="city" id="city"></div>
  </div>

  <div class="panel">
    <h2>Events</h2>
    <div class="log" id="eventLog"></div>
  </div>

  <div class="panel">
    <h2>Meta</h2>
    <div class="stat"><span>Play time</span><span id="playtime"></span></div>
    <div class="stat"><span>Ticks</span><span id="ticks"></span></div>
    <button onclick="resetGame()">Reset World</button>
  </div>
</main>

<script>
/* ============================================================
   CONFIG & STATE
============================================================ */
const STORAGE_KEY = "idle_realm_save";

const DEFAULT_STATE = {
  meta: {
    version: 1,
    createdAt: Date.now(),
    lastTick: Date.now()
  },
  realm: {
    era: "Foundations"
  },
  resources: {
    population: 10,
    production: 20,
    stability: 70
  },
  buildings: {
    settlement: 1,
    workshop: 0,
    council: 0
  },
  stats: {
    playTime: 0,
    ticks: 0
  },
  events: []
};

const BUILD_COSTS = {
  settlement: { production: 25, stability: 2 },
  workshop: { production: 40, stability: 4 },
  council: { production: 60, stability: 0 }
};

/* ============================================================
   LOAD / SAVE
============================================================ */
function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return structuredClone(DEFAULT_STATE);
  try { return JSON.parse(raw); }
  catch { return structuredClone(DEFAULT_STATE); }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ============================================================
   GAME LOGIC
============================================================ */
function applyTime() {
  const now = Date.now();
  const elapsed = Math.min(
    Math.floor((now - state.meta.lastTick) / 1000),
    86400
  );

  if (elapsed <= 0) return;

  const prodRate =
    state.resources.population * 0.1 +
    state.buildings.workshop * 0.6;

  state.resources.production += prodRate * elapsed;

  if (state.resources.stability > 50) {
    state.resources.population += elapsed * 0.01;
  }

  state.resources.stability +=
    state.buildings.council * 0.002 * elapsed;

  state.resources.stability -=
    elapsed * (0.004 + state.buildings.workshop * 0.001);

  state.resources.stability = Math.max(
    0, Math.min(100, state.resources.stability)
  );

  if (Math.random() < elapsed * 0.0002) {
    triggerEvent();
  }

  state.meta.lastTick = now;
  state.stats.playTime += elapsed;
  state.stats.ticks += elapsed;
}

/* ============================================================
   EVENTS
============================================================ */
function triggerEvent() {
  const e = state.resources.stability < 40
    ? "Unrest spreads among the population."
    : "A period of calm prosperity strengthens the realm.";

  state.events.unshift(e);
  state.events = state.events.slice(0, 20);
}

/* ============================================================
   BUILDINGS
============================================================ */
function build(type) {
  const cost = BUILD_COSTS[type];
  if (
    state.resources.production < cost.production ||
    state.resources.stability < cost.stability
  ) return;

  state.resources.production -= cost.production;
  state.resources.stability -= cost.stability;
  state.buildings[type]++;
  triggerEvent();
}

/* ============================================================
   RENDER
============================================================ */
function render() {
  document.getElementById("era").innerText = state.realm.era;
  document.getElementById("population").innerText =
    state.resources.population.toFixed(1);
  document.getElementById("production").innerText =
    state.resources.production.toFixed(1);
  document.getElementById("stability").innerText =
    state.resources.stability.toFixed(1);

  document.getElementById("playtime").innerText =
    Math.floor(state.stats.playTime / 60) + " min";
  document.getElementById("ticks").innerText = state.stats.ticks;

  const log = document.getElementById("eventLog");
  log.innerHTML = state.events.map(e => `â€¢ ${e}`).join("<br>");

  const city = document.getElementById("city");
  city.innerHTML = "";
  Object.entries(state.buildings).forEach(([k, v]) => {
    for (let i = 0; i < v; i++) {
      const d = document.createElement("div");
      d.className = "tile";
      d.innerText = k;
      city.appendChild(d);
    }
  });
}

/* ============================================================
   LOOP
============================================================ */
let state = loadState();

function loop() {
  applyTime();
  saveState();
  render();
}

setInterval(loop, 1000);
render();

/* ============================================================
   RESET
============================================================ */
function resetGame() {
  if (!confirm("Reset the realm?")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = structuredClone(DEFAULT_STATE);
  saveState();
  render();
}
</script>
</body>
</html>
