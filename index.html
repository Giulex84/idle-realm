<script>
/* =================================================
   IDLE REALM ‚Äî CORE SCRIPT (SAFE & ALIGNED)
   ================================================= */

let MAX_SLOTS = 9;
const COOLDOWN = 8;

/* ================= DOM ================= */
const popEl = document.getElementById("pop");
const prodEl = document.getElementById("prod");
const bronzeEl = document.getElementById("bronze");
const stabEl = document.getElementById("stab");
const timeEl = document.getElementById("time");

const eraTitle = document.getElementById("eraTitle");
const eraDesc = document.getElementById("eraDesc");
const objectives = document.getElementById("objectives");

const city = document.getElementById("city");
const eventsEl = document.getElementById("events");

const btnSettlement = document.getElementById("btnSettlement");
const btnWorkshop = document.getElementById("btnWorkshop");
const btnMine = document.getElementById("btnMine");
const btnCouncil = document.getElementById("btnCouncil");
const btnCouncil2 = document.getElementById("btnCouncil2");

/* ================= STATE ================= */
const DEFAULT = {
  era: "foundations",
  pop: 12,
  prod: 30,
  bronze: 0,
  stab: 100,
  time: 0,
  lastAction: 0,
  buildings: ["‚öíÔ∏è"],
  events: ["Realm founded with basic craftsmanship."],
  foundationsCompleted: false,
  bronzeStabilityTime: 0
};

let state = JSON.parse(localStorage.getItem("idleRealm"));
if (!state) state = JSON.parse(JSON.stringify(DEFAULT));

/* ================= UTIL ================= */
function save() {
  localStorage.setItem("idleRealm", JSON.stringify(state));
}

function log(msg) {
  state.events.unshift("‚Ä¢ " + msg);
  state.events = state.events.slice(0, 10);
}

function clamp() {
  state.prod = Math.max(0, state.prod);
  state.bronze = Math.max(0, state.bronze);
  state.stab = Math.min(100, Math.max(0, state.stab));
}

function canAct() {
  return Date.now() - state.lastAction >= COOLDOWN * 1000;
}

function count(sym) {
  return state.buildings.filter(b => b === sym).length;
}

/* ================= OBJECTIVES ================= */
function renderObjectives() {
  objectives.innerHTML = "";

  if (state.era === "foundations") {
    const goals = [
      { t: "Build 3 Settlements", ok: count("üè†") >= 3 },
      { t: "Reach 50 Production", ok: state.prod >= 50 },
      { t: "Establish the Council", ok: state.buildings.includes("üèõÔ∏è") },
      { t: "Stability ‚â• 70%", ok: state.stab >= 70 }
    ];

    let allOk = true;

    goals.forEach(g => {
      const d = document.createElement("div");
      d.className = "obj " + (g.ok ? "ok" : "");
      d.textContent = (g.ok ? "‚úì " : "‚Ä¢ ") + g.t;
      objectives.appendChild(d);
      if (!g.ok) allOk = false;
    });

    if (allOk) {
      state.foundationsCompleted = true;
      const btn = document.createElement("button");
      btn.textContent = "üè∫ Advance to Bronze Age (50 ‚öíÔ∏è)";
      btn.onclick = advanceEra;
      objectives.appendChild(btn);
    }
  }

  if (state.era === "bronze") {
    const d = document.createElement("div");
    d.textContent =
      `Stability ‚â• 85% for ${Math.floor(state.bronzeStabilityTime / 60)}:${(state.bronzeStabilityTime % 60)
        .toString()
        .padStart(2, "0")} / 5:00`;
    objectives.appendChild(d);
  }
}

/* ================= ERA ================= */
function advanceEra() {
  if (!state.foundationsCompleted) return;
  if (state.prod < 50) return log("Not enough production.");

  state.prod -= 50;
  state.era = "bronze";
  MAX_SLOTS = 12;
  log("üè∫ The Bronze Age begins.");
  clamp();
  update();
}

/* ================= BUILD ================= */
function canAfford(p, b = 0) {
  return state.prod >= p && state.bronze >= b;
}

function build(type) {
  if (!canAct()) return;

  if (type === "settlement" && canAfford(15)) {
    state.prod -= 15;
    state.pop += 4;
    state.stab -= 6;
    state.buildings.push("üè†");
  }
  else if (type === "workshop" && canAfford(20)) {
    state.prod -= 20;
    state.buildings.push("‚öíÔ∏è");
  }
  else if (type === "mine" && state.era === "bronze" && canAfford(30)) {
    state.prod -= 30;
    state.stab -= 4;
    state.buildings.push("‚õèÔ∏è");
  }
  else if (type === "council" && canAfford(30)) {
    state.prod -= 30;
    state.stab += 15;
    state.buildings.push("üèõÔ∏è");
  }
  else if (type === "council2" && state.era === "bronze" && canAfford(0, 30)) {
    const i = state.buildings.indexOf("üèõÔ∏è");
    if (i === -1) return log("Council required.");
    state.bronze -= 30;
    state.stab += 10;
    state.buildings[i] = "üèõÔ∏èüèõÔ∏è";
  }
  else {
    return log("Not enough resources.");
  }

  state.lastAction = Date.now();
  clamp();
  log(type + " built");
  update();
}

/* ================= REMOVE ================= */
function removeBuilding(i) {
  const b = state.buildings[i];
  if (!b) return;

  if (b === "üè†") state.pop -= 4;
  if (b === "‚õèÔ∏è") state.stab += 2;
  if (b === "üèõÔ∏è" || b === "üèõÔ∏èüèõÔ∏è") state.stab -= 5;

  state.buildings.splice(i, 1);
  clamp();
  log(b + " removed");
  update();
}

/* ================= BUTTONS ================= */
if (btnSettlement) btnSettlement.onclick = () => build("settlement");
if (btnWorkshop) btnWorkshop.onclick = () => build("workshop");
if (btnMine) btnMine.onclick = () => build("mine");
if (btnCouncil) btnCouncil.onclick = () => build("council");
if (btnCouncil2) btnCouncil2.onclick = () => build("council2");

/* ================= TICK ================= */
setInterval(() => {
  state.time++;

  // Production
  state.prod += count("‚öíÔ∏è") * 0.25;

  // Bronze (slow, balanced)
  if (state.era === "bronze") {
    state.bronze += count("‚õèÔ∏è") * 0.025 * (1 + count("‚öíÔ∏è") * 0.3);
  }

  // Stability from population
  if (state.pop < 20) state.stab -= 0.1;
  else if (state.pop >= 25 && state.pop < 30) state.stab += 0.05;
  else if (state.pop >= 30) state.stab += 0.1;

  // Bronze stability timer
  if (state.era === "bronze") {
    if (state.stab >= 85) state.bronzeStabilityTime++;
    else state.bronzeStabilityTime = 0;
  }

  clamp();
  update();
}, 1000);

/* ================= RENDER ================= */
function update() {
  popEl.textContent = state.pop;
  prodEl.textContent = state.prod.toFixed(1);
  bronzeEl.textContent = state.bronze.toFixed(1);
  stabEl.textContent = state.stab.toFixed(0);
  timeEl.textContent = state.time;

  eraTitle.innerHTML =
    "<b>" + (state.era === "foundations" ? "Foundations" : "Bronze Age") + "</b>";

  eraDesc.textContent =
    state.era === "foundations"
      ? "Fast growth to learn the game."
      : "A society tested by governance and time.";

  city.innerHTML = "";
  state.buildings.forEach((b, i) => {
    const d = document.createElement("div");
    d.className = "tile";
    d.textContent = b;
    d.onclick = () => removeBuilding(i);
    city.appendChild(d);
  });

  for (let i = state.buildings.length; i < MAX_SLOTS; i++) {
    const d = document.createElement("div");
    d.className = "tile";
    city.appendChild(d);
  }

  eventsEl.innerHTML = state.events.map(e => `<div>${e}</div>`).join("");
  renderObjectives();
  save();
}

update();
</script>
