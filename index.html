<script>
/* ==================================================
   IDLE REALM ‚Äî CORE LOGIC
   ERA 1 + ERA 2 ‚Äî FROZEN
   ================================================== */

let BASE_SLOTS = 9;
let EXTRA_SLOTS = 0;
const ACTION_COOLDOWN = 8;
const BRONZE_TIMER_TARGET = 300; // 5 minutes

const DEFAULT_STATE = {
  era: "foundations",
  pop: 12,
  prod: 30,
  bronze: 0,
  stab: 100,
  time: 0,
  lastAction: 0,

  buildings: [],
  events: ["Realm founded."],

  foundationsCompleted: false,
  bronzeStabilityTime: 0,
  bronzeFails: 0
};

let state = JSON.parse(localStorage.getItem("idleRealm")) || structuredClone(DEFAULT_STATE);

/* =========================
   UTILITIES
   ========================= */

function save() {
  localStorage.setItem("idleRealm", JSON.stringify(state));
}

function log(msg) {
  state.events.unshift("‚Ä¢ " + msg);
  state.events = state.events.slice(0, 10);
}

function clamp() {
  state.prod = Math.max(0, state.prod);
  state.bronze = Math.max(0, state.bronze);
  state.stab = Math.min(100, Math.max(0, state.stab));
}

function count(sym) {
  return state.buildings.filter(b => b === sym).length;
}

function canAct() {
  return Date.now() - state.lastAction >= ACTION_COOLDOWN * 1000;
}

/* =========================
   OBJECTIVES
   ========================= */

function renderObjectives() {
  objectives.innerHTML = "";

  if (state.era === "foundations") {
    const goals = [
      { text: "Build 3 Settlements", ok: count("üè†") >= 3 },
      { text: "Reach 50 Production", ok: state.prod >= 50 },
      { text: "Establish the Council", ok: state.buildings.includes("üèõÔ∏è") },
      { text: "Stability ‚â• 70%", ok: state.stab >= 70 }
    ];

    let allOk = true;

    goals.forEach(g => {
      const d = document.createElement("div");
      d.className = "obj " + (g.ok ? "ok" : "");
      d.textContent = (g.ok ? "‚úì " : "‚Ä¢ ") + g.text;
      objectives.appendChild(d);
      if (!g.ok) allOk = false;
    });

    if (allOk) {
      state.foundationsCompleted = true;
      const btn = document.createElement("button");
      btn.textContent = "üè∫ Advance to Bronze Age (50 ‚öíÔ∏è)";
      btn.onclick = advanceEra;
      objectives.appendChild(btn);
    }
  }

  if (state.era === "bronze") {
    const t = state.bronzeStabilityTime;
    const d = document.createElement("div");
    d.textContent =
      `Stability ‚â• 85% for ${Math.floor(t / 60)}:${(t % 60)
        .toString()
        .padStart(2, "0")} / 5:00`;
    objectives.appendChild(d);
  }
}

/* =========================
   ERA TRANSITION
   ========================= */

function advanceEra() {
  if (!state.foundationsCompleted) return;
  if (state.prod < 50) {
    log("Not enough production to advance.");
    return;
  }

  state.prod -= 50;
  state.era = "bronze";
  EXTRA_SLOTS = 3;
  state.lastAction = Date.now();
  log("üè∫ The Bronze Age begins.");
  clamp();
  save();
  update();
}

/* =========================
   BUILDING COSTS & CHECKS
   ========================= */

function canAfford(prod, bronze = 0) {
  return state.prod >= prod && state.bronze >= bronze;
}

function build(type) {
  if (!canAct()) return;

  if (type === "settlement") {
    if (!canAfford(15)) return log("Not enough production.");
    state.prod -= 15;
    state.pop += 4;
    state.stab -= 6;
    state.buildings.push("üè†");
  }

  if (type === "workshop") {
    if (!canAfford(20)) return log("Not enough production.");
    state.prod -= 20;
    state.buildings.push("‚öíÔ∏è");
  }

  if (type === "mine") {
    if (state.era !== "bronze") return;
    if (!canAfford(30)) return log("Not enough production.");
    state.prod -= 30;
    state.stab -= 4;
    state.buildings.push("‚õèÔ∏è");
  }

  if (type === "council") {
    if (!canAfford(30)) return log("Not enough production.");
    state.prod -= 30;
    state.stab += 15;
    state.buildings.push("üèõÔ∏è");
  }

  if (type === "council2") {
    if (state.era !== "bronze") return;
    if (!canAfford(0, 30)) return log("Not enough bronze.");
    const i = state.buildings.indexOf("üèõÔ∏è");
    if (i === -1) return log("Council required.");
    state.bronze -= 30;
    state.stab += 10;
    state.buildings[i] = "üèõÔ∏èüèõÔ∏è";
  }

  state.lastAction = Date.now();
  clamp();
  save();
  update();
}

/* =========================
   REMOVE BUILDINGS
   ========================= */

function removeBuilding(i) {
  const b = state.buildings[i];
  if (!b) return;

  if (b === "üè†") state.pop -= 4;
  if (b === "‚õèÔ∏è") state.stab += 2;
  if (b === "üèõÔ∏è" || b === "üèõÔ∏èüèõÔ∏è") state.stab -= 5;

  state.buildings.splice(i, 1);
  clamp();
  save();
  log(b + " removed.");
  update();
}

/* =========================
   TICK LOOP
   ========================= */

setInterval(() => {
  state.time++;

  // Production
  state.prod += count("‚öíÔ∏è") * 0.25;

  // Bronze
  if (state.era === "bronze") {
    state.bronze += count("‚õèÔ∏è") * 0.25;
  }

  // Stability from population
  if (state.pop < 20) state.stab -= 0.1;
  else if (state.pop >= 25 && state.pop < 30) state.stab += 0.05;
  else if (state.pop >= 30) state.stab += 0.1;

  // Bronze stability timer
  if (state.era === "bronze") {
    if (state.stab >= 85) {
      state.bronzeStabilityTime++;
    } else {
      if (state.bronzeStabilityTime > 0) {
        state.bronzeFails++;
        log("‚ö†Ô∏è Stability faltered. The council struggles to hold order.");
      }
      state.bronzeStabilityTime = 0;
    }
  }

  clamp();
  save();
  update();
}, 1000);

/* =========================
   RENDER
   ========================= */

function update() {
  pop.textContent = state.pop;
  prod.textContent = state.prod.toFixed(1);
  bronze.textContent = state.bronze.toFixed(1);
  stab.textContent = state.stab.toFixed(0);
  time.textContent = state.time;

  eraTitle.innerHTML =
    "<b>" + (state.era === "foundations" ? "Foundations" : "Bronze Age") + "</b>";

  eraDesc.textContent =
    state.era === "foundations"
      ? "Fast growth to learn the game."
      : "A society tested by governance and time.";

  city.innerHTML = "";
  const slots = BASE_SLOTS + (state.era === "bronze" ? EXTRA_SLOTS : 0);

  state.buildings.forEach((b, i) => {
    const d = document.createElement("div");
    d.className = "tile";
    d.textContent = b;
    d.onclick = () => removeBuilding(i);
    city.appendChild(d);
  });

  for (let i = state.buildings.length; i < slots; i++) {
    const d = document.createElement("div");
    d.className = "tile";
    city.appendChild(d);
  }

  events.innerHTML = state.events.map(e => `<div>${e}</div>`).join("");
  renderObjectives();
}

update();
</script>
