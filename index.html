<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Pi SDK Baseline</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>

<h1>Pi SDK Baseline</h1>

<button id="loginBtn">Login with Pi</button>
<button id="payBtn" disabled>Pay 1 Pi</button>

<p id="status"></p>

<script>
  Pi.init({ version: "2.0" });

  let currentUser = null;

  document.getElementById("loginBtn").onclick = async () => {
    try {
      const auth = await Pi.authenticate(["username"], () => {});
      currentUser = auth.user;
      document.getElementById("status").innerText =
        "Welcome: " + currentUser.username;
      document.getElementById("payBtn").disabled = false;
    } catch {
      document.getElementById("status").innerText = "Login failed";
    }
  };

  document.getElementById("payBtn").onclick = () => {
    Pi.createPayment({
      amount: 1,
      memo: "Idle Realm Test Payment",
      metadata: { app: "idle-realm" },

      onReadyForServerApproval: async (paymentId) => {
        await fetch("/api/pi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "approve",
            paymentId
          })
        });
      },

      onReadyForServerCompletion: async (paymentId, txid) => {
        document.getElementById("status").innerText =
          "Payment completed ✔️";
      },

      onCancel: () => {
        document.getElementById("status").innerText =
          "Payment cancelled";
      },

      onError: (err) => {
        document.getElementById("status").innerText =
          "Payment error";
        console.error(err);
      }
    });
  };
</script>

</body>
</html>
