<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Idle Realm</title>

<style>
:root{
  --bg:#0b1220;
  --card:#141933;
  --card2:#1b2546;
  --accent:#2f5bff;
  --danger:#ff4d6d;
  --warn:#ffb703;
  --text:#e6ecff;
  --muted:#9aa4c7;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto}
body{
  margin:0;
  background:linear-gradient(180deg,#0a1020,#050a14);
  color:var(--text);
}
header{
  position:sticky;top:0;z-index:10;
  background:#060b18;
  display:flex;justify-content:space-between;
  padding:10px 12px;font-size:13px;
}
main{padding:16px;max-width:520px;margin:auto}
h1{margin:0 0 4px}
.small{font-size:13px;color:var(--muted)}
.card{
  background:linear-gradient(180deg,var(--card),var(--card2));
  border-radius:16px;padding:16px;margin-bottom:16px;
}
button{
  width:100%;padding:16px;border-radius:14px;border:none;
  background:var(--accent);color:white;font-size:16px;
  margin-bottom:10px;
}
button.alt{background:#3a456e}
button.danger{background:var(--danger)}
button:disabled{opacity:.45}
.grid{
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
}
.tile{
  background:#0f1730;border-radius:12px;height:72px;
  display:flex;align-items:center;justify-content:center;
  font-size:28px;
  position:relative;
}
.tile.empty{opacity:.15}
.tile.selectable{outline:2px solid var(--warn)}
.goal{padding:6px 0;font-size:14px}
.goal.done{color:#7dffb3}
.overlay{
  position:fixed;inset:0;
  background:rgba(5,10,20,.85);
  display:none;align-items:center;justify-content:center;
  z-index:50;
}
.overlay .card{max-width:420px;width:90%}
</style>
</head>

<body>

<header>
  <span>ğŸ‘¥ <b id="pop"></b></span>
  <span>âš’ï¸ <b id="prod"></b></span>
  <span>ğŸ›¡ï¸ <b id="stab"></b>%</span>
  <span>ğŸª¨ <b id="ore"></b></span>
  <span>ğŸ¥‰ <b id="bronze"></b></span>
  <span>â³ <b id="time"></b></span>
</header>

<main>

<h1 id="title">Idle Realm</h1>
<div class="small">A strategic realm shaped by irreversible choices</div>

<div class="card">
  <h2>Decisions</h2>

  <button id="btnSettle">ğŸ  Settle Families (âš’ï¸15)</button>
  <button id="btnWork">âš’ï¸ Workshop (âš’ï¸20)</button>
  <button id="btnCouncil">ğŸ›ï¸ Council (âš’ï¸30)</button>

  <button id="btnMine" style="display:none">â›ï¸ Mine (âš’ï¸40)</button>
  <button id="btnSmelter" style="display:none">ğŸ”¥ Smelter (âš’ï¸60 + ğŸª¨10)</button>

  <button class="alt" id="btnPolicy" style="display:none">âš–ï¸ Enact Industrial Policy</button>

  <div class="small" id="info"></div>
</div>

<div class="card">
  <h2>City</h2>
  <div class="grid" id="city"></div>
  <button class="danger" id="btnSelectRemove">ğŸ§¹ Dismantle a District</button>
  <div class="small">Choose which district to dismantle. No refunds.</div>
</div>

<div class="card">
  <h2>Era Objectives</h2>
  <div id="goals"></div>
</div>

<div class="card">
  <h2>Era</h2>
  <div><b id="eraTitle"></b></div>
  <div class="small" id="eraDesc"></div>
</div>

<div class="card">
  <h2>Chronicle</h2>
  <div id="events"></div>
</div>

</main>

<!-- SELECT DISMANTLE OVERLAY -->
<div class="overlay" id="overlay">
  <div class="card">
    <h2>Select a District</h2>
    <div class="grid" id="selectGrid"></div>
    <button class="alt" onclick="closeOverlay()">Cancel</button>
  </div>
</div>

<script>
const BASE_SLOTS=9;
const COOLDOWN=8;
const COST={settlement:15,workshop:20,council:30,mine:40,smelter:60};

const DEFAULT={
  era:"foundations",
  pop:12,prod:30,stab:100,time:0,lastAction:0,
  buildings:["âš’ï¸"],
  events:["Realm founded with basic craftsmanship"],
  ore:0,bronze:0,policy:null,lastSeen:Date.now()
};

function loadState(){
  let s;
  try{s=JSON.parse(localStorage.getItem("idleRealm"));}
  catch{return structuredClone(DEFAULT);}
  for(const k in DEFAULT)
    if(typeof s[k]!==typeof DEFAULT[k]) s[k]=DEFAULT[k];
  if(!Array.isArray(s.buildings)) s.buildings=["âš’ï¸"];
  if(!Array.isArray(s.events)) s.events=[];
  return s;
}
let state=loadState();

function save(){
  state.lastSeen=Date.now();
  localStorage.setItem("idleRealm",JSON.stringify(state));
}

function log(msg,star=false){
  state.events.unshift((star?"â˜… ":"â€¢ ")+msg);
  state.events=state.events.slice(0,7);
}

function canAct(){
  return Date.now()-state.lastAction>=COOLDOWN*1000;
}
function maxSlots(){return state.era==="bronze"?12:BASE_SLOTS;}

function eraGoals(){
  if(state.era==="foundations"){
    return [
      {txt:"Build a Council",ok:state.buildings.includes("ğŸ›ï¸")},
      {txt:"Fill all city slots",ok:state.buildings.length>=BASE_SLOTS}
    ];
  }
  return [
    {txt:"Produce 50 Bronze",ok:state.bronze>=50},
    {txt:"Build 2 Smelters",ok:state.buildings.filter(b=>b==="ğŸ”¥").length>=2},
    {txt:"Maintain Stability 100%",ok:state.stab>=100}
  ];
}

function update(){
  pop.innerText=state.pop.toFixed(1);
  prod.innerText=state.prod.toFixed(0);
  stab.innerText=Math.max(0,Math.min(100,state.stab)).toFixed(0);
  ore.innerText=state.ore.toFixed(0);
  bronze.innerText=state.bronze.toFixed(0);
  time.innerText=state.time;

  info.innerText=canAct()
    ?"Choose carefully. Every action reshapes the realm."
    :"The realm responds to your last decreeâ€¦";

  btnSettle.disabled=!canAct()||state.prod<COST.settlement||state.buildings.length>=maxSlots();
  btnWork.disabled=!canAct()||state.prod<COST.workshop||state.buildings.length>=maxSlots();
  btnCouncil.disabled=!canAct()||state.prod<COST.council||state.buildings.includes("ğŸ›ï¸");

  btnMine.style.display=state.era==="bronze"?"block":"none";
  btnSmelter.style.display=state.era==="bronze"?"block":"none";
  btnPolicy.style.display=state.era==="bronze"&&!state.policy?"block":"none";

  btnMine.disabled=!canAct()||state.prod<COST.mine||state.buildings.length>=maxSlots();
  btnSmelter.disabled=!canAct()||state.prod<COST.smelter||state.ore<10||state.buildings.length>=maxSlots();

  city.innerHTML="";
  for(let i=0;i<maxSlots();i++){
    const t=document.createElement("div");
    t.className="tile"+(state.buildings[i]?"":" empty");
    t.innerText=state.buildings[i]||"";
    city.appendChild(t);
  }

  goals.innerHTML=eraGoals().map(g=>
    `<div class="goal ${g.ok?"done":""}">${g.ok?"âœ”":"â—»"} ${g.txt}</div>`
  ).join("");

  if(state.era==="foundations"){
    eraTitle.innerText="Foundations";
    eraDesc.innerText="Survival, growth and irreversible decisions.";
  }else{
    eraTitle.innerText="Age of Bronze";
    eraDesc.innerText="Industry risesâ€¦ but darker times loom beyond the horizon.";
  }

  events.innerHTML=state.events.map(e=>`<div class="small">${e}</div>`).join("");
  save();
}

function act(){state.lastAction=Date.now();update();}

function build(type){
  if(!canAct()) return;
  if(type==="settlement"){state.prod-=15;state.pop+=4;state.stab-=6;state.buildings.push("ğŸ ");log("Families settle the land");}
  if(type==="workshop"){state.prod-=20;state.buildings.push("âš’ï¸");log("Craftsmanship expands");}
  if(type==="council"){state.prod-=30;state.stab+=15;state.buildings.push("ğŸ›ï¸");log("Order is established",true);}
  if(type==="mine"){state.prod-=40;state.stab-=2;state.buildings.push("â›ï¸");log("Miners dig deeper");}
  if(type==="smelter"){state.prod-=60;state.ore-=10;state.stab-=3;state.buildings.push("ğŸ”¥");log("Bronze reshapes production");}
  act();
}

btnSettle.onclick=()=>build("settlement");
btnWork.onclick=()=>build("workshop");
btnCouncil.onclick=()=>build("council");
btnMine.onclick=()=>build("mine");
btnSmelter.onclick=()=>build("smelter");

btnPolicy.onclick=()=>{
  state.policy="industrial";
  state.prod*=1.15;
  state.stab-=10;
  log("An industrial doctrine reshapes society",true);
  act();
};

/* ==== SELECTIVE DISMANTLE ==== */
btnSelectRemove.onclick=()=>{
  const grid=document.getElementById("selectGrid");
  grid.innerHTML="";
  state.buildings.forEach((b,i)=>{
    const t=document.createElement("div");
    t.className="tile selectable";
    t.innerText=b;
    t.onclick=()=>{
      state.buildings.splice(i,1);
      log(`A ${b} district is dismantled`);
      closeOverlay();
      update();
    };
    grid.appendChild(t);
  });
  overlay.style.display="flex";
};
function closeOverlay(){overlay.style.display="none";}

/* ==== DEBUG RESET ==== */
const debugEnabled=new URLSearchParams(location.search).get("debug")==="true";
let pressTimer;
title.addEventListener("touchstart",()=>{
  pressTimer=setTimeout(()=>{
    if(debugEnabled){
      localStorage.removeItem("idleRealm");
      location.reload();
    }
  },5000);
});
title.addEventListener("touchend",()=>clearTimeout(pressTimer));

/* ==== LOOP ==== */
setInterval(()=>{
  state.time++;
  const w=state.buildings.filter(b=>b==="âš’ï¸").length;
  const m=state.buildings.filter(b=>b==="â›ï¸").length;
  const s=state.buildings.filter(b=>b==="ğŸ”¥").length;
  state.prod+=w*0.8;
  state.ore+=m*0.3;
  state.bronze+=Math.min(s*0.2,state.ore);
  if(state.stab<100) state.stab+=0.1;
  update();
},1000);

update();
</script>

</body>
</html>
