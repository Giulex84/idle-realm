<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Idle Realm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    Pi.init({ version: "2.0" });
  </script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top, #0e1530, #050814);
      color: #fff;
    }
    .card {
      background: linear-gradient(180deg, #121c3f, #0b1025);
      border-radius: 18px;
      padding: 20px;
      margin: 16px;
    }
    h1, h2, h3 { margin-top: 0; }
    button {
      width: 100%;
      padding: 14px;
      margin: 6px 0;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background: #3b82f6;
      color: #fff;
    }
    button:disabled {
      background: #1e3a8a;
      opacity: 0.5;
      cursor: not-allowed;
    }
    .danger { background: #fb7185; }
    .muted { opacity: 0.6; font-size: 14px; }
    .check { color: #4ade80; }
    .slot-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }
    .slot {
      height: 64px;
      border-radius: 12px;
      background: #0b1333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }
    .cooldown {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
</head>

<body>

<div id="termsCard" class="card">
  <h2>Terms of Service & Privacy Policy</h2>
  <p class="muted">
    Idle Realm is provided "as is" for entertainment purposes only.
    No payments or ads are enabled during review.
    Balance and mechanics may change.
  </p>
  <p class="muted">
    This app does not collect, store, or transmit personal data.
    No analytics or tracking services are used.
  </p>
  <label>
    <input type="checkbox" id="acceptTerms" />
    I agree to the Terms of Service and Privacy Policy
  </label>
  <button id="enterGame" disabled>Continue to Idle Realm</button>
</div>

<div id="game" style="display:none">

  <div class="card">
    <h1>Idle Realm</h1>
    <p class="muted">A strategic realm shaped by irreversible choices</p>
    <div id="stats"></div>
  </div>

  <div class="card">
    <h2 id="eraTitle"></h2>
    <p class="muted" id="eraDesc"></p>
  </div>

  <div class="card">
    <h3>Era Objectives</h3>
    <div id="objectives"></div>
    <button id="advanceEra" disabled>Advance to Next Era</button>
  </div>

  <div class="card">
    <h3>Decisions</h3>
    <div id="decisions"></div>
    <p class="muted" id="cooldownText"></p>
  </div>

  <div class="card">
    <h3>City Slots</h3>
    <div class="slot-grid" id="slots"></div>
  </div>

  <div class="card">
    <h3>Chronicle</h3>
    <div id="log" class="muted"></div>
  </div>

  <div class="card">
    <button class="danger" onclick="resetProgress()">Reset Progress (Review Mode)</button>
    <p class="muted">Temporary. Will be removed after review.</p>
  </div>

</div>

<script>
/* ---------------- STATE ---------------- */
const ERAS = [
  {
    id: 1,
    name: "Tribal Age",
    desc: "Small settlements and survival.",
    cooldown: 5000,
    slots: 5,
    objectives: () => [
      { label: "Population ‚â• 6", done: state.population >= 6 },
      { label: "Tools ‚â• 40", done: state.tools >= 40 },
      { label: "Council built", done: state.council >= 1 },
      { label: "Stability ‚â• 80%", done: state.stability >= 80 }
    ]
  },
  {
    id: 2,
    name: "Age of Bronze",
    desc: "Industry and specialization emerge.",
    cooldown: 8000,
    slots: () => 5 + state.council,
    objectives: () => [
      { label: "Build 1 Mine", done: state.mine >= 1 },
      { label: "Build 1 Smelter", done: state.smelter >= 1 },
      { label: "Produce 50 Bronze", done: state.bronze >= 50 },
      { label: "Stability ‚â• 80%", done: state.stability >= 80 }
    ]
  },
  {
    id: 3,
    name: "Iron Age",
    desc: "External threats loom. (Coming soon)",
    locked: true
  }
];

let state = JSON.parse(localStorage.getItem("idleRealm")) || {
  era: 1,
  population: 1,
  tools: 20,
  ore: 0,
  bronze: 0,
  stability: 100,
  slotsUsed: [],
  council: 0,
  mine: 0,
  smelter: 0,
  lastAction: 0,
  log: []
};

/* ---------------- AUTH + TERMS ---------------- */
Pi.authenticate(["username"], () => {}, () => {});
const enterBtn = document.getElementById("enterGame");
document.getElementById("acceptTerms").onchange = e => {
  enterBtn.disabled = !e.target.checked;
};
enterBtn.onclick = () => {
  document.getElementById("termsCard").style.display = "none";
  document.getElementById("game").style.display = "block";
  render();
};

/* ---------------- GAME LOGIC ---------------- */
function cooldownReady() {
  const cd = ERAS[state.era - 1].cooldown;
  return Date.now() - state.lastAction >= cd;
}

function action(fn) {
  if (!cooldownReady()) return;
  fn();
  state.lastAction = Date.now();
  save();
  render();
}

function addLog(msg) {
  state.log.unshift(msg);
  state.log = state.log.slice(0, 20);
}

function save() {
  localStorage.setItem("idleRealm", JSON.stringify(state));
}

/* ---------------- ACTIONS ---------------- */
function settle() {
  action(() => {
    if (state.tools < 15) return;
    state.tools -= 15;
    state.population += 0.5;
    state.stability -= 2;
    state.slotsUsed.push("üè†");
    addLog("Families settled");
  });
}

function workshop() {
  action(() => {
    state.tools += 5;
    state.stability -= 1;
    state.slotsUsed.push("üîß");
    addLog("Workshop operated");
  });
}

function buildCouncil() {
  action(() => {
    if (state.tools < 30) return;
    state.tools -= 30;
    state.stability += 15;
    state.council++;
    state.slotsUsed.push("üèõ");
    addLog("Council established");
  });
}

function buildMine() {
  action(() => {
    if (state.tools < 40) return;
    state.tools -= 40;
    state.mine++;
    state.slotsUsed.push("‚õè");
    addLog("Mine built");
  });
}

function buildSmelter() {
  action(() => {
    if (state.tools < 60 || state.ore < 10) return;
    state.tools -= 60;
    state.ore -= 10;
    state.smelter++;
    state.slotsUsed.push("üî•");
    addLog("Smelter built");
  });
}

/* ---------------- ERA ADVANCE ---------------- */
function canAdvance() {
  const era = ERAS[state.era - 1];
  return era.objectives().every(o => o.done);
}

function advanceEra() {
  if (!canAdvance()) return;
  state.era++;
  addLog(`Entered ${ERAS[state.era - 1].name}`);
  save();
  render();
}

/* ---------------- RESET ---------------- */
function resetProgress() {
  localStorage.removeItem("idleRealm");
  location.reload();
}

/* ---------------- RENDER ---------------- */
function render() {
  const era = ERAS[state.era - 1];

  document.getElementById("stats").innerHTML = `
    üë• ${state.population.toFixed(1)} |
    üîß ${state.tools} |
    ‚õè ${state.ore} |
    ü™ô ${state.bronze} |
    üõ° ${state.stability}%
  `;

  document.getElementById("eraTitle").innerText = era.name;
  document.getElementById("eraDesc").innerText = era.desc;

  document.getElementById("objectives").innerHTML =
    era.objectives().map(o =>
      `<div>${o.done ? "‚úî" : "‚òê"} ${o.label}</div>`
    ).join("");

  document.getElementById("advanceEra").disabled = !canAdvance();
  document.getElementById("advanceEra").onclick = advanceEra;

  const decisions = [];
  if (state.era === 1) {
    decisions.push(`<button onclick="settle()">üè† Settle Families (15 tools)</button>`);
    decisions.push(`<button onclick="workshop()">üîß Workshop (+5 tools)</button>`);
    decisions.push(`<button onclick="buildCouncil()">üèõ Council (30 tools)</button>`);
  }
  if (state.era === 2) {
    decisions.push(`<button onclick="buildMine()">‚õè Mine (40 tools)</button>`);
    decisions.push(`<button onclick="buildSmelter()">üî• Smelter (60 tools + 10 ore)</button>`);
    decisions.push(`<button onclick="buildCouncil()">üèõ Council (30 tools)</button>`);
  }

  document.getElementById("decisions").innerHTML = decisions.join("");

  document.getElementById("slots").innerHTML =
    Array.from({ length: typeof era.slots === "function" ? era.slots() : era.slots })
      .map((_, i) => `<div class="slot">${state.slotsUsed[i] || ""}</div>`)
      .join("");

  document.getElementById("log").innerHTML =
    state.log.map(l => `<div>‚Ä¢ ${l}</div>`).join("");

  const cdLeft = Math.max(0, era.cooldown - (Date.now() - state.lastAction));
  document.getElementById("cooldownText").innerText =
    cdLeft > 0 ? `Cooldown: ${(cdLeft / 1000).toFixed(1)}s` : "";
}

render();
</script>

</body>
</html>
