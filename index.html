<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Idle Realm</title>

    <!-- PI SDK (NON TOCCARE) -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
      Pi.init({ version: "2.0" });
    </script>

    <style>
      body {
        font-family: system-ui, -apple-system;
        background: #0f1115;
        color: #eaeaea;
        padding: 24px;
      }

      h1 {
        margin-bottom: 4px;
      }

      button {
        padding: 8px 12px;
        border-radius: 6px;
        border: none;
        background: #3a6df0;
        color: white;
        cursor: pointer;
        margin-right: 6px;
        margin-top: 6px;
      }

      button:disabled {
        background: #444;
        cursor: not-allowed;
      }

      .panel {
        background: #1a1d24;
        padding: 16px;
        border-radius: 8px;
        margin-top: 16px;
      }

      pre {
        white-space: pre-wrap;
        font-size: 14px;
        line-height: 1.4;
      }
    </style>
  </head>

  <body>
    <h1>Idle Realm</h1>
    <p>Local-first idle strategy world</p>

    <div class="panel">
      <pre id="output">loading...</pre>
    </div>

    <div class="panel">
      <h3>Build</h3>
      <button onclick="build('settlement')">Settlement</button>
      <button onclick="build('workshop')">Workshop</button>
      <button onclick="build('council')">Council</button>
    </div>

    <div class="panel">
      <button onclick="resetGame()">Reset World</button>
    </div>

    <script>
      /*************************************************
       * CONFIG
       *************************************************/
      const STORAGE_KEY = "idle_realm_save";

      const DEFAULT_STATE = {
        meta: {
          version: 1,
          createdAt: Date.now(),
          lastTick: Date.now()
        },

        realm: {
          name: "Idle Realm",
          era: "foundations"
        },

        resources: {
          population: 10,
          production: 20,
          stability: 70
        },

        buildings: {
          settlement: 1,
          workshop: 0,
          council: 0
        },

        stats: {
          totalPlayTime: 0,
          ticks: 0
        }
      };

      const BUILDING_COSTS = {
        settlement: { production: 20, stability: 2 },
        workshop: { production: 30, stability: 5 },
        council: { production: 50, stability: 0 }
      };

      /*************************************************
       * LOAD / SAVE
       *************************************************/
      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(DEFAULT_STATE);
        try {
          return migrateState(JSON.parse(raw));
        } catch {
          return structuredClone(DEFAULT_STATE);
        }
      }

      function saveState(state) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function migrateState(state) {
        if (!state.meta || state.meta.version !== 1) {
          return structuredClone(DEFAULT_STATE);
        }
        return state;
      }

      /*************************************************
       * IDLE TIME SIMULATION
       *************************************************/
      function applyTime(state) {
        const now = Date.now();
        const elapsedMs = now - state.meta.lastTick;
        const elapsedSeconds = Math.floor(elapsedMs / 1000);
        if (elapsedSeconds <= 0) return state;

        // Production rate
        const productionRate =
          state.resources.population * 0.1 +
          state.buildings.workshop * 0.5;

        state.resources.production += productionRate * elapsedSeconds;

        // Population growth
        if (state.resources.stability > 50) {
          state.resources.population +=
            elapsedSeconds * (0.01 + state.buildings.settlement * 0.002);
        }

        // Stability effects
        state.resources.stability -=
          elapsedSeconds * (0.003 + state.buildings.workshop * 0.001);

        state.resources.stability +=
          state.buildings.council * 0.002 * elapsedSeconds;

        state.resources.stability = Math.max(
          0,
          Math.min(100, state.resources.stability)
        );

        state.meta.lastTick = now;
        state.stats.ticks += elapsedSeconds;
        state.stats.totalPlayTime += elapsedSeconds;

        return state;
      }

      /*************************************************
       * BUILDINGS
       *************************************************/
      function canAfford(cost, state) {
        return (
          state.resources.production >= cost.production &&
          state.resources.stability >= cost.stability
        );
      }

      function build(type) {
        const cost = BUILDING_COSTS[type];
        if (!canAfford(cost, state)) return;

        state.resources.production -= cost.production;
        state.resources.stability -= cost.stability;
        state.buildings[type]++;
        saveState(state);
        render(state);
      }

      /*************************************************
       * RENDER
       *************************************************/
      function render(state) {
        document.getElementById("output").innerText = `
ERA: ${state.realm.era}

RESOURCES
- Population : ${state.resources.population.toFixed(1)}
- Production : ${state.resources.production.toFixed(1)}
- Stability  : ${state.resources.stability.toFixed(1)}

BUILDINGS
- Settlement : ${state.buildings.settlement}
- Workshop   : ${state.buildings.workshop}
- Council    : ${state.buildings.council}

STATS
- Play time  : ${Math.floor(state.stats.totalPlayTime / 60)} min
- Ticks      : ${state.stats.ticks}
`;
      }

      /*************************************************
       * GAME LOOP
       *************************************************/
      let state = loadState();

      function gameLoop() {
        state = applyTime(state);
        saveState(state);
        render(state);
      }

      setInterval(gameLoop, 1000);
      render(state);

      /*************************************************
       * RESET
       *************************************************/
      function resetGame() {
        if (!confirm("Reset the world?")) return;
        localStorage.removeItem(STORAGE_KEY);
        state = structuredClone(DEFAULT_STATE);
        saveState(state);
        render(state);
      }
    </script>
  </body>
</html>
