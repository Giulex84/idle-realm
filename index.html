<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Idle Realm</title>

<style>
:root{
  --card:#141c33;
  --card2:#1b2546;
  --accent:#2f6bff;
  --bronze:#c27c2c;
  --text:#e6ecff;
  --muted:#9aa4c7;
  --ok:#22c55e;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto}
body{margin:0;background:linear-gradient(180deg,#0a1020,#050a14);color:var(--text)}
header{
  position:sticky;top:0;z-index:10;
  background:#060b18;
  padding:8px 12px;
  display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;
  font-size:14px;
}
main{padding:16px;max-width:500px;margin:auto}
.card{background:linear-gradient(180deg,var(--card),var(--card2));border-radius:16px;padding:16px;margin-bottom:16px}
button{width:100%;border:none;border-radius:14px;padding:14px;margin-bottom:10px;background:var(--accent);color:white;font-size:16px}
button.bronze{background:linear-gradient(180deg,#e0a24c,#b87328);color:#1a0f00;font-weight:600}
button:disabled{opacity:.4}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.tile{background:#0f1730;border-radius:12px;height:70px;display:flex;align-items:center;justify-content:center;font-size:28px}
.small{font-size:13px;color:var(--muted)}
.obj{font-size:14px;margin-bottom:4px}
.obj.ok{color:var(--ok)}
.advisor{font-size:12px;color:#aab3ff;margin-top:10px;text-align:center}
</style>
</head>

<body>

<header>
  <span>ğŸ‘¥ <b id="pop"></b></span>
  <span>âš’ï¸ <b id="prod"></b></span>
  <span>ğŸ¥‰ <b id="bronze"></b></span>
  <span>ğŸ›¡ï¸ <b id="stab"></b>%</span>
  <span>â³ <b id="time"></b></span>
</header>

<main>
<h1>Idle Realm</h1>
<div class="small">A living world shaped by time and choices</div>

<div class="card">
  <h2>Era</h2>
  <div id="eraTitle"></div>
  <div id="eraDesc" class="small"></div>
  <div id="objectives"></div>
  <button id="advanceEra" class="bronze" style="display:none">
    ğŸ¥‰ Enter the Bronze Age (50 âš’ï¸)
  </button>
</div>

<div class="card">
  <h2>Build</h2>
  <button id="btnSettle">ğŸ  Settlement</button>
  <button id="btnWork">âš’ï¸ Workshop</button>
  <button id="btnCouncil">ğŸ›ï¸ Council</button>
  <button id="btnCouncil2" style="display:none">ğŸ›ï¸ Council II</button>
  <button id="btnMine" style="display:none">â›ï¸ Mine</button>
  <div class="small" id="info"></div>
</div>

<div class="card">
  <h2>City</h2>
  <div class="grid" id="city"></div>
</div>

<div class="card">
  <h2>Events</h2>
  <div id="events"></div>
  <div class="advisor" id="advisor"></div>
</div>
</main>

<script>
/* ===== CONFIG ===== */
let MAX_SLOTS = 9;
const COOLDOWN = 8;
const ERA2_COST = 50;
const CALM_TIME = 30;

const COST = {
  settlement:15,
  workshop:20,
  council:30,
  council2:50,
  mine:25
};

const DEFAULT = {
  v:2,
  era:"foundations",
  pop:12,
  prod:30,
  bronze:0,
  stab:100,
  time:0,
  lastAction:0,
  lastChange:Date.now(),
  buildings:["âš’ï¸"],
  councilLv:1,
  objTime:[0,0,0],
  events:["â€¢ Realm founded with basic craftsmanship"]
};

let state = load();

/* ===== LOAD / SAVE ===== */
function load(){
  try{
    const s = JSON.parse(localStorage.getItem("idleRealm"));
    if(!s || s.v !== DEFAULT.v) throw "reset";
    return Object.assign(structuredClone(DEFAULT), s);
  }catch{
    localStorage.removeItem("idleRealm");
    return structuredClone(DEFAULT);
  }
}
function save(){
  localStorage.setItem("idleRealm", JSON.stringify(state));
}
function canAct(){
  return Date.now() - state.lastAction >= COOLDOWN*1000;
}
function log(msg){
  state.events.unshift("â€¢ "+msg);
  state.events = state.events.slice(0,10);
}

/* ===== OBJECTIVES ===== */
function eraObjectives(){
  if(state.era==="foundations"){
    return [
      ["Build 3 Settlements", state.buildings.filter(b=>b==="ğŸ ").length>=3],
      ["Reach 50 Production", state.prod>=50],
      ["Establish the Council", state.buildings.includes("ğŸ›ï¸")],
      ["Stability â‰¥ 70%", state.stab>=70]
    ];
  }
  return [
    ["Stability â‰¥ 85% (sustained)", state.objTime[0]>=600],
    ["Maintain Bronze Society", state.objTime[1]>=900],
    ["Govern Population Growth", state.objTime[2]>=900]
  ];
}

/* ===== UPDATE ===== */
function update(){
  pop.innerText = state.pop;
  prod.innerText = state.prod.toFixed(1);
  bronze.innerText = state.bronze.toFixed(2);
  stab.innerText = Math.round(state.stab);
  time.innerText = state.time;

  eraTitle.innerHTML = state.era==="foundations"
    ? "<b>Foundations</b>"
    : "<b>Bronze Age</b>";

  eraDesc.innerText = state.era==="foundations"
    ? "Fast growth to understand the game."
    : "Growth slows. Governance matters.";

  objectives.innerHTML="";
  eraObjectives().forEach(o=>{
    const d=document.createElement("div");
    d.className="obj"+(o[1]?" ok":"");
    d.innerText=(o[1]?"âœ” ":"â˜ ")+o[0];
    objectives.appendChild(d);
  });

  advanceEra.style.display =
    state.era==="foundations" && eraObjectives().every(o=>o[1])
      ? "block":"none";
  advanceEra.disabled = state.prod < ERA2_COST;

  btnMine.style.display =
    btnCouncil2.style.display =
      state.era==="bronze" ? "block":"none";

  info.innerText =
    `Settlement ${COST.settlement} | Workshop ${COST.workshop} | Council ${COST.council}` +
    (state.era==="bronze"
      ? ` | Mine ${COST.mine} | Council II ${COST.council2}`
      : "") +
    (canAct() ? " â€¢ Ready" : "");

  city.innerHTML="";
  for(let i=0;i<MAX_SLOTS;i++){
    const t=document.createElement("div");
    t.className="tile";
    t.innerText=state.buildings[i]||"â¬œ";
    t.onclick=()=>remove(i);
    city.appendChild(t);
  }

  advisor.innerText = advisorText();
  events.innerHTML = state.events.map(e=>`<div>${e}</div>`).join("");
  save();
}

/* ===== ACTIONS ===== */
function act(){
  state.lastAction=Date.now();
  state.lastChange=Date.now();
}
function build(type,icon){
  if(!canAct() || state.prod < COST[type] || state.buildings.length>=MAX_SLOTS) return;
  state.prod -= COST[type];
  state.buildings.push(icon);
  if(type==="settlement"){state.pop+=4; state.stab-=6;}
  if(type==="council"){state.stab+=15;}
  log(icon+" constructed");
  act();
  update();
}
function remove(i){
  if(state.era!=="bronze") return;
  const b = state.buildings[i];
  if(!b || b==="ğŸ›ï¸") return;
  state.buildings.splice(i,1);
  log(b+" removed");
  act();
  update();
}

/* ===== BUTTONS ===== */
btnSettle.onclick=()=>build("settlement","ğŸ ");
btnWork.onclick=()=>build("workshop","âš’ï¸");
btnCouncil.onclick=()=>build("council","ğŸ›ï¸");
btnMine.onclick=()=>build("mine","â›ï¸");
btnCouncil2.onclick=()=>{
  if(!canAct() || state.prod < COST.council2 || state.councilLv===2) return;
  state.prod -= COST.council2;
  state.councilLv = 2;
  log("Council strengthened");
  act();
  update();
};

/* ===== ERA TRANSITION ===== */
advanceEra.onclick=()=>{
  state.prod -= ERA2_COST;
  state.era = "bronze";
  MAX_SLOTS = 12;
  log("The Bronze Age begins");
  act();
  update();
};

/* ===== TICK ===== */
setInterval(()=>{
  state.time++;

  const w = state.buildings.filter(b=>b==="âš’ï¸").length;
  const m = state.buildings.filter(b=>b==="â›ï¸").length;
  const hasCouncil = state.buildings.includes("ğŸ›ï¸");

  state.prod += w * 0.22;
  state.bronze += m * 0.05;

  let pressure = Math.max(0, (w+m)-3);
  let inertia = 1 + Math.max(0, state.pop-20)/20;

  if(pressure>0){
    let loss = pressure * 0.05 / inertia;
    if(hasCouncil) loss *= 0.6;
    state.stab -= loss;
  }

  if(state.stab < 100) state.stab += 0.02 / inertia;

  if(
    state.era==="bronze" &&
    hasCouncil &&
    Date.now()-state.lastChange >= CALM_TIME*1000 &&
    (w+m)<=3
  ){
    let bonus = (state.pop/40)*0.05;
    if(state.councilLv===2) bonus*=1.4;
    state.stab += bonus;
  }

  if(state.era==="bronze"){
    let speed = 1/(1+Math.max(0,state.pop-20)/20);
    if(state.councilLv===2) speed*=1.25;
    if(state.stab>=85) state.objTime[0]+=speed;
    if(state.bronze>0 && state.stab>=75) state.objTime[1]+=speed;
    if(hasCouncil && state.pop>=28 && state.stab>=80) state.objTime[2]+=speed;
  }

  update();
},1000);

function advisorText(){
  if(state.era==="bronze" && Date.now()-state.lastChange<CALM_TIME*1000)
    return "The realm needs time to settle.";
  if(state.stab<75) return "A society pushed too hard resists.";
  return "Governance is earned through restraint.";
}

update();
</script>
</body>
</html>
